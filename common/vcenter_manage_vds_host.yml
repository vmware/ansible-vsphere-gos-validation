# Copyright 2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Add or remove ESXi host for a vSphere Distributed Switch
# Parameters:
#   vds_name: The vSphere Distributed Switch name.
#   vds_host_state: The ESXi host state on the vSphere Distributed Switch: present or absent.
#   vds_host_vmnics: A list of ESXi vmnics to use with the vSphere Distributed Switch.

- name: "Check paramters for managing ESXi host on vSphere Distributed Switch"
  ansible.builtin.assert:
    that:
      - vds_name is defined and vds_name
      - vds_host_state is defined
      - vds_host_state in ['present', 'absent']
    fail_msg: >-
      At least one of parameters 'vds_name' and 'vds_host_state' is incorrect.

- name: "Check parameter 'vds_host_vmnics' is set to a vmnics list"
  ansible.builtin.assert:
    that:
      - vds_host_vmnics is defined
      - vds_host_vmnics | type_debug == 'list'
    fail_msg: "'vds_host_vmnics' must be set with a list of ESXi physical adapters."
  when: vds_host_state == 'present'

- name: "Set operation for managing ESXi host on vSphere Distributed Switch"
  ansible.builtin.set_fact:
    vds_host_op: "{% if vds_host_state == 'present' %}add{% else %}remove{% endif %}"

- name: "{{ vds_host_op | capitalize }} ESXi host '{{ esxi_hostname }}' for vSphere Distributed Switch"
  community.vmware.vmware_dvs_host:
    hostname: "{{ vsphere_host_name }}"
    username: "{{ vsphere_host_user }}"
    password: "{{ vsphere_host_user_password }}"
    validate_certs: "{{ validate_certs | default(false) }}"
    esxi_hostname: '{{ esxi_hostname }}'
    switch_name: "{{ vds_name }}"
    state: "{{ vds_host_state }}"
    vmnics: "{{ vds_host_vmnics | default(omit) }}"
  register: manage_vds_host_result

- name: "Check the result of {{ vds_host_op | regex_replace('e$', 'ing') }} ESXi host for vSphere Distributed Switch"
  ansible.builtin.assert:
    that:
      - manage_vds_host_result is defined
      - manage_vds_host_result.changed is defined
      - manage_vds_host_result.changed
    fail_msg: "Failed to {{ vds_host_op }} ESXi host '{{ esxi_hostname }}' for vSphere Distributed Switch"
