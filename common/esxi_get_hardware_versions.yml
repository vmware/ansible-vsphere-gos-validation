# Copyright 2021 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Get all supported hardware versions on ESXi server
# Return:
#   esxi_hardware_versions: A list of all supported hardware versions on ESXi server
#   esxi_default_hardware_version: The deafult hardware version on the ESXi server

- name: "Initialized ESXi server supported hardware version list and default hardware version"
  set_fact:
    esxi_hardware_versions: []
    esxi_default_hardware_version: ""
    esxi_latest_hardware_version: ""

- name: "Get ESXi server supported hardware versions"
  community.vmware.vmware_vm_config_option:
    hostname: "{{ vsphere_host_name }}"
    username: "{{ vsphere_host_user }}"
    password: "{{ vsphere_host_user_password }}"
    validate_certs: "{{ validate_certs | default(False) }}"
    datacenter: "{{ vsphere_host_datacenter }}" 
    esxi_hostname: "{{ esxi_hostname }}"
    get_hardware_versions: True
  register: get_hardware_versions_result
  ignore_errors: True

- block:
    - name: "Set fact of ESXi server supported hardware versions and default hardware version"
      set_fact:
        esxi_hardware_versions: "{{ get_hardware_versions_result.instance['Supported hardware versions'] | map('regex_replace', 'vmx-0?', '') | map('int') }}"
        esxi_default_hardware_version: "{{ get_hardware_versions_result.instance['Default hardware version'] | regex_replace('vmx-0?', '') }}"

    - name: "Set fact of ESXi server latest hardware version"
      set_fact:
        esxi_latest_hardware_version: "{{ esxi_hardware_versions | max }}"
      when: esxi_hardware_versions | length > 0
  when:
    - get_hardware_versions_result is defined
    - get_hardware_versions_result.instance is defined
    - get_hardware_versions_result.instance['Supported hardware versions'] is defined
    - get_hardware_versions_result.instance['Default hardware version'] is defined

- block:
    - name: "Get all hardware versions on ESXi server"
      shell: "ls /etc/vmware/hostd/env/esx-hw*.xml"
      register: esxi_hw_files
      delegate_to: "{{ esxi_hostname }}"
    
    - block:
        - name: "Set fact of ESXi server supported hardware versions"
          set_fact:
            esxi_hardware_versions: "{{ esxi_hw_files.stdout_lines | regex_findall('(?<=hw)\\d+') | map('int') | difference([99]) }}"
    
        - name: "Set fact of ESXi server latest hardware version"
          set_fact:
            esxi_latest_hardware_version: "{{ esxi_hardware_versions | max }}"
    
        - name: "Get default hardware version"
          shell: "grep -l '<defaultConfigOption>true</defaultConfigOption>' /etc/vmware/hostd/env/esx-hw*.xml"
          register: esxi_default_hw_file
          delegate_to: "{{ esxi_hostname }}"
    
        - name: "Set fact of ESXi server default hardware version"
          set_fact:
            esxi_default_hardware_version: "{{ esxi_default_hw_file.stdout | regex_search('(?<=hw)\\d+') }}"
          when:
            - esxi_default_hw_file is defined
            - esxi_default_hw_file.stdout is defined
      when:
        - esxi_hw_files is defined
        - esxi_hw_files.stdout_lines is defined
  when: >
    get_hardware_versions_result is undefined or
    get_hardware_versions_result.instance is undefined or
    get_hardware_versions_result.instance['Supported hardware versions'] is undefined or
    get_hardware_versions_result.instance['Default hardware version'] is undefined

- debug:
    msg:
      - "ESXi server supported hardware versions: {{ esxi_hardware_versions }}"
      - "ESXi server latest hardware version: {{ esxi_latest_hardware_version }}"
      - "ESXi server default hardware version: {{ esxi_default_hardware_version }}"
