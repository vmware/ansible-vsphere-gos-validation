# Copyright 2021-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Add a serial port to VM with backing file
# Return:
#   vm_serial_file_backing: The file backing info of VM serial port
#   vm_serial_file_name: The file name of VM serial port backing file
#
- name: "Initialize facts of VM serial port file path, name and backing info"
  ansible.builtin.set_fact:
    vm_serial_file_ds_path: "{{ vm_files_path_ds.strip('\\/') }}/serial-{{ current_test_timestamp }}.log"
    vm_serial_file_name: ""
    vm_serial_file_backing: {}

- name: "Add a serial port with backing file to VM"
  community.vmware.vmware_guest_serial_port:
    hostname: "{{ vsphere_host_name }}"
    username: "{{ vsphere_host_user }}"
    password: "{{ vsphere_host_user_password }}"
    validate_certs: "{{ validate_certs | default(false) }}"
    name: "{{ vm_name }}"
    backings:
      - type: "file"
        file_path: "{{ vm_serial_file_ds_path }}"
        yield_on_poll: true
  register: add_serial_port_result

- name: "Check the serial port is added successfully"
  ansible.builtin.assert:
    that:
      - add_serial_port_result.serial_port_info is defined
      - (add_serial_port_result.serial_port_info |
         selectattr('file_path', 'defined') |
         selectattr('file_path', 'equalto', vm_serial_file_ds_path) | length > 0)
    fail_msg: "Failed to add a serial port with backing file {{ vm_serial_file_ds_path }}"

- name: "Set fact of VM serial port file name and backing info"
  ansible.builtin.set_fact:
    vm_serial_file_name: "{{ vm_serial_file_ds_path | basename }}"
    vm_serial_file_backing: {'type': 'file', 'fileName': '{{ vm_serial_file_ds_path }}'}

- name: "Display the VM serial port file backing info"
  ansible.builtin.debug: var=vm_serial_file_backing
