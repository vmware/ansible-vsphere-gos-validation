# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Get the NFS server and volume from OVA path
- set_fact:
    ova_nfs_server: "{{ ova_nfs_server_path.split(':')[0] }}"
    ova_nfs_volume: "{{ ova_nfs_server_path.split(':')[1] }}"

# Create a temporary directory to mount NFS storage
- include_tasks: create_temp_file_dir.yml
  vars:
    tmp_state: "directory"
    tmp_prefix: "nfs_"

- name: "Set fact of the temp dir"
  set_fact:
    tmp_nfs_mount_dir: "{{ tmp_path }}"

# Mount OS Image folder
- include_tasks: local_mount.yml
  vars:
    mount_src: "{{ ova_nfs_server }}:{{ ova_nfs_volume }}"
    mount_path: "{{ tmp_nfs_mount_dir }}"
    mount_fstype: "nfs"

- name: "Set fact of the NFS mount result"
  set_fact:
    ova_nfs_mounted: "{% if nfs_mount_result is defined and nfs_mount_result.changed %}True{% else %}False{% endif %}"

- name: "Get OVA path and file name"
  set_fact:
    vm_ova_path: "{{ tmp_nfs_mount_dir }}/{{ ova_path }}"
    vm_ova_name: "{{ ova_path | basename }}"
