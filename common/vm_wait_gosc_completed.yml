# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Wait for guest customization completed state keyword in vmware.log
# Parameter:
#   check_gosc_state_keyword: True to check GOSC state keyword exists in vmware.log.
#
- name: Initialize the key string status
  set_fact:
    get_keystring: 0

- name: Initialize the fact to check GOSC state keyword
  set_fact:
    check_gosc_state_keyword: true
  when: check_gosc_state_keyword is undefined

- name: Set fact of the key strings
  set_fact:
    gosc_state_keyword: "ToolsDeployPkgPublishState: state=5, code=0"

# Note: gosc_state_keyword means guest custmization is completed
- include_tasks: vm_wait_logbundle_msg.yml
  vars:
    vm_wait_logbundle_name: "vmware.log"
    vm_wait_logbundle_msg: "{{ gosc_state_keyword }}"
    vm_wait_logbundle_retries: "{{ get_guest_reset_time_retries | default(40) }}"
    vm_wait_logbundle_delay: 30
    vm_wait_logbundle_ignore_errors: True

- name: "Set the result of getting GOSC state code"
  set_fact:
    gosc_state_keyword_found: "{{ get_vm_logbundle_content is defined and get_vm_logbundle_content.content is defined and gosc_state_keyword in get_vm_logbundle_content.content}}"

# Fail when not get VM gosc state keyword in vmware.log
- name: Check guest customization state
  fail:
    msg: "Not found '{{ gosc_state_keyword }}' in vmware.log"
  when:
    - check_gosc_state_keyword is defined
    - check_gosc_state_keyword | bool
    - not gosc_state_keyword_found | bool
