# Copyright 2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Collect VM serial port log file
# Parameters:
#   vm_dir_name: VM directory name, which is defined in vm_get_vm_info.yml
#   vm_serial_file_name: VM serial port file name, which is defined in vm_add_serial_port.yml
#   vm_serial_file_local_name: the local file name of downloaded serial port log file
# Return:
#   vm_serial_file_local_path: the local path to downloaded serial port log file   
#
- name: "Initialize facts of downloaded serial port log file name and path"
  ansible.builtin.set_fact:
    vm_serial_file_local_path: ""

- name: "Collect VM serial port log"
  when:
    - vm_dir_name is defined
    - vm_dir_name
    - vm_serial_file_name is defined
    - vm_serial_file_name
  block:
    - name: "Download VM serial port log file from datastore"
      include_tasks: ../../common/esxi_download_datastore_file.yml
      vars:
        src_datastore: "{{ datastore }}"
        src_file_path: "{{ vm_dir_name }}/{{ vm_serial_file_name }}"
        dest_file_path: "{{ current_test_log_folder }}/{{ vm_serial_file_name }}"
        download_file_fail_ignore: true

    - name: "Get the local path to downloaded serial port log"
      when:
        - file_in_datastore_result is defined
        - file_in_datastore_result == 'Success'
        - datastore_file_download_result.changed is defined
        - datastore_file_download_result.changed
      block:
        - name: "Check downloaded VM serial log at local"
          ansible.builtin.stat:
            path: "{{ current_test_log_folder }}/{{ vm_serial_file_name }}"
          register: local_file_stat_result
          ignore_errors: True

        - name: "Set fact of downloaded serial log path at local"
          ansible.builtin.set_fact:
            vm_serial_file_local_path: "{{ current_test_log_folder }}/{{ vm_serial_file_name }}"
          when:
            - local_file_stat_result.stat.exists is defined
            - local_file_stat_result.stat.exists
