# Copyright 2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   This test case is used for check the scripts in response to power operations
#   When VMware tools is not installed or not running in VM, this test case result is 'Blocked'.
#
- name: power_operation_script
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "Test case block"
      block:
        - name: "Test setup"
          include_tasks: ../setup/test_setup.yml
          vars:
            skip_test_no_vmtools: true

        # When check power on script, we need to disable shutdown script firstly: vmware-toolbox-cmd script shutdown disable
        # When check shutdown script, we need to disable poweron script firstly: vmware-toolbox-cmd script power disable
        # When check suspend script, we need to disable resume script firstly: vmware-toolbox-cmd script resume disable
        # When check resume script, we need to disable suspend script firstly: vmware-toolbox-cmd script suspend disable
        - name: "Set fact of power operations"
          ansible.builtin.set_fact:
            power_operation_list:
              - name: poweronDefaultScript
                file_path: /etc/vmware-tools/poweron-vm-defaul
                setup: 
                  - vmware-toolbox-cmd script shutdown disable
                cmds:
                  - vmware-toolbox-cmd script power enable
                check: 
                  - vmware-toolbox-cmd script power current
              - name: poweroffDefaultScript
                file_path: /etc/vmware-tools/poweroff-vm-default
                setup: 
                  - vmware-toolbox-cmd script power disable
                cmds:
                  - vmware-toolbox-cmd script shutdown enable
                check: 
                  - vmware-toolbox-cmd script shutdown current
              - name: poweronCustomeScript
                file_path: /tmp/poweron-vm-custom
                setup: 
                  - vmware-toolbox-cmd script shutdown disable
                  - rm -rf /tmp/poweron.tag && rm -rf /tmp/poweron-vm-custom
                cmds:
                  - echo 'touch /tmp/poweron.tag' >> /tmp/poweron-vm-custom
                  - vmware-toolbox-cmd script power set /tmp/poweron-vm-custom
                check: 
                  - vmware-toolbox-cmd script power current
                  - ls /tmp/poweron.tag
              - name: poweroffCustomeScript
                file_path: /tmp/poweroff-vm-custom
                setup: 
                  - vmware-toolbox-cmd script power disable
                  - rm -rf /tmp/poweroff.tag && rm -rf /tmp/poweroff-vm-custom
                cmds:
                  - echo 'touch /tmp/poweroff.tag' >> /tmp/poweroff-vm-custom
                  - vmware-toolbox-cmd script shutdown set /tmp/poweroff-vm-custom
                check: 
                  - vmware-toolbox-cmd script shutdown current
                  - ls /tmp/poweroff.tag
              - name: suspendCustomeScript
                file_path: /tmp/suspend-vm-custom
                setup: 
                  - vmware-toolbox-cmd script resume disable
                  - rm -rf /tmp/suspend.tag && rm -rf /tmp/suspend-vm-custom
                cmds:
                  - echo 'touch /tmp/suspend.tag' >> /tmp/suspend-vm-custom
                  - vmware-toolbox-cmd script suspend set /tmp/suspend-vm-custom
                check: 
                  - vmware-toolbox-cmd script suspend current
                  - ls /tmp/suspend.tag
              - name: resumeCustomeScript
                file_path: /tmp/resume-vm-custom
                setup: 
                  - vmware-toolbox-cmd script suspend disable
                  - rm -rf /tmp/resume.tag && rm -rf /tmp/resume-vm-custom
                cmds:
                  - echo 'touch /tmp/resume.tag' >> /tmp/resume-vm-custom
                  - vmware-toolbox-cmd script resume set /tmp/resume-vm-custom
                check: 
                  - vmware-toolbox-cmd script resume current
                  - ls /tmp/resume.tag

        - name: "Test power script"
          include_tasks: set_power_script.yml
          vars:
            script_file_path: "{{ power_script_item.file_path }}"
          with_items: "{{ power_operation_list }}"
          when: power_script_item
          loop_control:
            loop_var: power_script_item
      rescue:
        - name: "Test case failure"
          include_tasks: ../../common/test_rescue.yml
