# Copyright 2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   Set and check soft power operation
# # Parameters:
#   power_script_ops: power script operation which reprent the testcase

- name: "Start testcase {{ power_script_ops }}"
  ansible.builtin.debug:
    msg:
      - "Start testcase {{ power_script_ops }}"

- name: "Set fact of power operation"
  ansible.builtin.set_fact:
    power_ops: "{{ power_script_ops.split('_')[0] }}"
    power_script_type: "{{ power_script_ops.split('_')[1] }}"
    script_file_path: |-
      {%- if power_script_type == 'default' -%}/etc/vmware-tools/{{ power_ops }}-vm-{{ power_script_type }}
      {%- else -%}/var/{{ power_ops }}-vm-{{ power_script_type }}
      {%- endif -%}
    power_cmd_ops_type: |-
      {%- if power_ops == 'poweron' -%}power
      {%- elif power_ops == 'poweroff' -%}shutdown
      {%- else -%}{{ power_ops }}
      {%- endif %}

# When check power on script, we need to disable shutdown script firstly
# When check shutdown script, we need to disable poweron script firstly
# When check suspend script, we need to disable resume script firstly
# When check resume script, we need to disable suspend script firstly
- name: "Setup for testcase {{ power_script_ops }}"
  block:
    - name: "Clean the configuration for testcase {{ power_script_ops }}"
      ansible.builtin.shell: |-
        {%- if power_ops == 'poweron' -%}vmware-toolbox-cmd script shutdown disable
        {%- elif power_ops == 'poweroff' -%}vmware-toolbox-cmd script power disable
        {%- elif power_ops == 'suspend' -%}vmware-toolbox-cmd script resume disable
        {%- elif power_ops == 'resume' -%}vmware-toolbox-cmd script suspend disable
        {%- endif %}
      delegate_to: "{{ vm_guest_ip }}"
    
    - name: "Clean the existing script files for testcase {{ power_script_ops }}"
      ansible.builtin.shell: "rm -rf /var/{{ power_ops }}.tag && rm -rf /var/{{ power_ops }}-vm-{{ power_script_type }}"
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true
      when: power_script_type == "custom"

- name: "Create script file for testcase {{ power_script_ops }}"
  ansible.builtin.shell: "echo 'touch /var/{{ power_ops }}.tag' >> /var/{{ power_ops }}-vm-custom"
  delegate_to: "{{ vm_guest_ip }}"
  when: power_script_type == "custom"

- name: "Modify the mode of script file"
  ansible.builtin.file:
    path: "{{ script_file_path }}"
    state: touch
    mode: "777"
  delegate_to: "{{ vm_guest_ip }}"

- name: "Set script file for testcase {{ power_script_ops }}"
  ansible.builtin.shell: |-
      {%- if power_script_type == 'custom' -%}vmware-toolbox-cmd script power set {{ script_file_path }}
      {%- else -%}vmware-toolbox-cmd script {{ power_cmd_ops_type }} enable
      {%- endif -%}
  delegate_to: "{{ vm_guest_ip }}"

- name: "Check the current configuration for testcase {{ power_script_ops }}"
  ansible.builtin.shell: vmware-toolbox-cmd script {{ power_cmd_ops_type }} current
  register: power_script_result
  delegate_to: "{{ vm_guest_ip }}"

- name: "Print the current configuration for testcase {{ power_script_ops }}"
  ansible.builtin.debug: var=power_script_result.stdout

- name: "Check current configuration is expected"
  ansible.builtin.assert:
    that:
      - power_script_result.stdout.strip() == script_file_path
    fail_msg: "The configuration for {{ power_script_ops }} is {{ power_script_result.stdout }}, not as expected {{ script_file_path }}."
    success_msg: "The configuration for {{ power_script_ops }} is {{ power_script_result.stdout }}, which is as expected."

# Won't works with untils/reboot.yml for poweroff event
- name: "Shutdown and then powerOn guest OS"
  when: power_ops is match('^(poweroff|poweron)')
  block:
    - name: "Shutdown VM"
      include_tasks: ../../common/vm_set_power_state.yml
      vars:
        vm_power_state_set: "shutdown-guest"

    - name: "Power on VM"
      include_tasks: ../../common/vm_set_power_state.yml
      vars:
        vm_power_state_set: "powered-on"

    - name: "Update inventory"
      include_tasks: ../../common/update_inventory.yml

- name: "Suspended guest of target vm and then resumed"
  when: power_ops is match('^(suspend|resume)')
  block:
    - name: "Suspend the VM"
      include_tasks: ../../common/vm_set_power_state.yml
      vars:
        vm_power_state_set: 'suspended'

    - name: "Power on VM"
      include_tasks: ../../common/vm_set_power_state.yml
      vars:
        vm_power_state_set: "powered-on"
        force: true

    - name: "Update inventory"
      include_tasks: ../../common/update_inventory.yml

- name: "Get content of file tools.conf"
  ansible.builtin.shell: "cat /etc/vmware-tools/tools.conf"
  register: tools_conf_content_result
  delegate_to: "{{ vm_guest_ip }}"

- name: "Set fact of power script config in tools.conf"
  ansible.builtin.set_fact:
    power_script_filename: "{{ script_file_path.split('/')[-1].strip() }}"

- name: "Check the configuration is expected in tools.conf"
  ansible.builtin.assert:
    that:
      - tools_conf_content_result.stdout is defined
      - tools_conf_content_result.stdout.find(power_script_filename) != -1
    fail_msg: "Not found the {{ script_file_path }} in tool.conf for {{ power_script_ops }}, which is not as expected"
    success_msg: "Found the {{ script_file_path }} in tool.conf for {{ power_script_ops }}, which is as expected."

- name: "Check the script running as expected"
  ansible.builtin.shell: "ls /var/{{ power_ops }}.tag"
  delegate_to: "{{ vm_guest_ip }}"
  when: 
    - power_script_type == "custom"
    - power_ops != "suspend"

- name: "End of testcase {{ power_script_ops }}"
  ansible.builtin.debug:
    msg:
      - "End of testcase {{ power_script_ops }}"

