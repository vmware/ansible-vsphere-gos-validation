# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
- include_tasks: ../../common/vm_hot_add_ctrl_disk.yml
  vars:
    disk_controller_type: "{{ new_disk_ctrl_type }}"
    ctrl_number: "{{ new_ctrl_number }}"
    unit_number: "{{ new_unit_number }}"
  when: add_new_controller

- include_tasks: ../../common/vm_hot_add_remove_disk.yml
  vars:
    disk_operation: 'present'
    disk_controller_type: "{{ new_disk_ctrl_type }}"
    ctrl_number: "{{ new_ctrl_number }}"
    unit_number: "{{ new_unit_number }}"
  when: not add_new_controller

- include_tasks: wait_device_list_changed.yml
  vars:
    device_list_before_change: "{{ old_device_list }}"
    wait_device_state: "present"

- name: "Set fact of new device list and new device name"
  ansible.builtin.set_fact:
    new_device_list: "{{ device_list_after_change }}"
    new_device_name: "{{ (device_list_after_change | difference(old_device_list))[0] }}"

# Create new partition and run test on the new disk
- name: "Get new block device"
  ansible.builtin.set_fact:
    device: "{{ new_device_list | difference(old_device_list) }}"
- name: "Print new device block name"
  ansible.builtin.debug: var=device
- name: "Check new device file is created"
  ansible.builtin.assert:
    that:
      - device | length == 1
    fail_msg: "Hotadd disk failed due to no new disk device on VM."
    success_msg: "Hotadd disk succeed, new disk device on VM."

- name: "Set new device block name"
  ansible.builtin.set_fact:
    device_name: "{{ device[0] }}"

- name: "Print new device block name"
  ansible.builtin.debug: var=device_name

- name: "Create new partition on the new disk {{ device_name }}"
  include_tasks: ../utils/create_disk_partition.yml
  vars:
    disk_name: "{{ device_name }}"
    partition_fstype: "ext4"

- name: "Set fact of new partition name and device path"
  ansible.builtin.set_fact:
    new_partition_name: "{{ partition_name }}"
    new_partition_device_path: "{{ partition_device_path }}"
    new_partition_fstype: "ext4"

- name: "Test disk I/O on new disk {{ device_name }}"
  include_tasks: test_disk_io.yml
  vars:
    test_disk_name: "{{ device_name }}"

- name: "Test file read/write on new partition {{ new_partition_device_path }}"
  include_tasks: test_file_read_write.yml
  vars:
    test_partition_name: "{{ new_partition_name }}"
    test_partition_device_path: "{{ new_partition_device_path }}"
    test_partition_fstype: "{{ new_partition_fstype }}"

- include_tasks: ../../common/vm_hot_add_remove_disk.yml
  vars:
    disk_operation: 'absent'
    ctrl_number: "{{ new_ctrl_number }}"
    unit_number: "{{ new_unit_number }}"
    disk_controller_type: "{{ new_disk_ctrl_type }}"

- include_tasks: wait_device_list_changed.yml
  vars:
    device_list_before_change: "{{ new_device_list }}"
    wait_device_name: "{{ new_device_name }}"
    wait_device_state: "absent"
