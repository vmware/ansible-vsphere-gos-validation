# Copyright 2023-2026 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Prepare for network device testing
#
- name: "Get guest network device manager"
  include_tasks: ../utils/get_network_manager.yml
  when: >-
    guest_os_network_manager is undefined or
    not guest_os_network_manager

- name: "Install 'distrib-compat' for {{ vm_guest_os_distribution }}"
  include_tasks: ../utils/install_uninstall_package.yml
  vars:
    package_list: ["distrib-compat"]
    package_state: "present"
  when:
    - guest_os_ansible_distribution == "VMware Photon OS"
    - guest_os_ansible_distribution_major_ver | int < 4

- name: "Install 'iputils-ping' for {{ vm_guest_os_distribution }}"
  include_tasks: ../utils/install_uninstall_package.yml
  vars:
    package_list: ["iputils-ping"]
    package_state: "present"
  when:
    - guest_os_ansible_distribution == "Ubuntu"
    - guest_os_edition not in ["Desktop", "Server"]

- name: "Reload '8021q' module in {{ vm_guest_os_distribution }}"
  include_tasks: ../utils/reload_module.yml
  vars:
    module_name: "8021q"
  when:
    - guest_os_ansible_distribution in ["SLES", "SLED"]
    - guest_os_ansible_distribution_major_ver | int == 12

- name: "Disable firewall in guest OS"
  include_tasks: ../utils/disable_firewall.yml

- name: "Get primary network adapter information before network device testing"
  include_tasks: ../utils/get_primary_network_adapter.yml

- name: "Set fact of network adapters before network device testing"
  ansible.builtin.set_fact:
    network_macs_before_add: "{{ guest_network_adapters_mac | unique }}"

- name: "Prepare for PVRDMA testing"
  when: adapter_type == "pvrdma"
  block:
    - name: "Install rdma packages on {{ vm_guest_os_distribution }}"
      include_tasks: ../utils/install_uninstall_package.yml
      vars:
        package_list: ["rdma-core", "rdmacm-utils", "ibverbs-utils"]
        package_state: "present"
      when: guest_os_family == "Debian"

    - name: "Install rdma packages in {{ vm_guest_os_distribution }}"
      include_tasks: ../utils/install_uninstall_package.yml
      vars:
        package_list: ["rdma-core", "librdmacm-utils", "libibverbs-utils"]
        package_state: "present"
      when: guest_os_family in ["Suse", "RedHat"]

    - name: "Get network config file state"
      include_tasks: ../utils/get_file_stat_info.yml
      vars:
        guest_file_path: "{{ guest_primary_nic_config_path }}"

    - name: "Update network config file to remove MAC address for '{{ guest_primary_nic_name }}'"
      when: guest_file_exists
      block:
        - name: "Print the network config file"
          ansible.builtin.debug: var=guest_primary_nic_config_path
        - name: "Print the content of the network config file before changing"
          ansible.builtin.shell: "cat {{ guest_primary_nic_config_path }}"
          delegate_to: "{{ vm_guest_ip }}"
          ignore_errors: true

        - name: "Remove MAC address or UUID from network config file for '{{ guest_primary_nic_name }}'"
          ansible.builtin.lineinfile:
            path: "{{ guest_primary_nic_config_path }}"
            regexp: "^uuid|^UUID|^MAC|^mac|^HWADDR"
            state: absent
          delegate_to: "{{ vm_guest_ip }}"
          when: guest_os_network_manager != "netplan"

        - name: "Update netplan config for '{{ guest_primary_nic_name }}'"
          when: guest_os_network_manager == "netplan"
          block:
            - name: "Remove MAC address from netplan config file for '{{ guest_primary_nic_name }}'"
              ansible.builtin.lineinfile:
                path: "{{ guest_primary_nic_config_path }}"
                regexp: "^ *(match|macaddress|set-name)"
                state: absent
              delegate_to: "{{ vm_guest_ip }}"

            - name: "Apply new netplan config"
              include_tasks: reload_network_configs.yml

    - name: "Print the content of the network config file after changing"
      ansible.builtin.shell: "cat {{ guest_primary_nic_config_path }}"
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true

    - name: "Get all VM serial ports"
      include_tasks: ../../common/vm_get_serial_ports.yml

    - name: "Remove VM serial port devices"
      when: vm_serial_backings | length > 0
      block:
        - name: "Shutdown guest OS for removing serial port"
          include_tasks: ../utils/shutdown.yml

        - name: "Remove VM serial port"
          include_tasks: ../../common/vm_remove_serial_port.yml
          vars:
            vm_serial_backing: "{{ item }}"
          with_items: "{{ vm_serial_backings }}"

        - name: "Power on VM"
          include_tasks: ../../common/vm_set_power_state.yml
          vars:
            vm_power_state_set: 'powered-on'

        - name: "Update VM guest IP in inventory"
          include_tasks: ../../common/update_inventory.yml

    # Clone a new VM as PVRDMA client VM from current VM, and current VM as server
    - name: "Clone a new VM as client VM from current VM"
      include_tasks: ../../common/vm_instant_clone.yml
      vars:
        parent_vm_name: "{{ pvrdma_server_vm_name }}"
        cloned_vm_name: "{{ pvrdma_client_vm_name }}"

    - name: "Pause 30 seconds after VM instant clone"
      ansible.builtin.pause:
        seconds: 30

    - name: "Set fact of client VM exists"
      ansible.builtin.set_fact:
        pvrdma_client_vm_exists: true

    # The instant cloned VM has same IP address with parent VM.
    # Resetting it to get a new DHCP IP address
    - name: "Reset client VM '{{ pvrdma_client_vm_name }}' for getting DHCP IP address"
      include_tasks: ../../common/vm_set_power_state.yml
      vars:
        vm_power_state_set: 'restarted'
        vm_name: "{{ pvrdma_client_vm_name }}"
