# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Shutdown VM via executing shutdown command in VM
- name: Execute guest OS shutdown
  ansible.builtin.command: "shutdown -h now"
  delegate_to: "{{ vm_guest_ip }}"
  become: true
  changed_when: false
  async: 1
  poll: 0
  when: guest_os_family != "FreeBSD"

# The 'shutdown -h now' will let FreeBSD to halt
- name: Execute guest OS shutdown for FreeBSD
  ansible.builtin.command: "poweroff"
  delegate_to: "{{ vm_guest_ip }}"
  become: true
  changed_when: false
  async: 1
  poll: 0
  when: guest_os_family == "FreeBSD"

- name: "Wait for port 22 to become stopped"
  ansible.builtin.wait_for:
    port: 22
    host: "{{ vm_guest_ip }}"
    state: "stopped"

- include_tasks: ../../common/vm_wait_power_state.yml
  vars:
    expected_power_status: 'poweredOff'
    wait_power_state_timeout: 300
