# Copyright 2023-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Get network network config file for an interface
# Parameters:
#   network_adapter_name: The network interface name
#   network_adapter_is_primary(optional): The given network interface name is the primary network interface.
#     Default is false.
# Return:
#   network_config_path: The network interface config file path
#   network_connection_name: The network connection name managed by NetworkManager.
#
- name: "Initialize facts of network config file and connection name for {{ network_adapter_name }}"
  ansible.builtin.set_fact:
    network_config_path: ""
    network_connection_name: ""

- name: "Get network device manager in guest OS"
  include_tasks: get_network_manager.yml
  when: >-
    guest_os_network_manager is undefined or
    not guest_os_network_manager

- name: "Get network config file from NetworkManager"
  when: guest_os_network_manager == "NetworkManager"
  block:
    - name: "Get active network connection for '{{ network_adapter_name }}'"
      ansible.builtin.shell: "nmcli -t -f DEVICE,FILENAME,NAME connection show --active | grep '^{{ network_adapter_name }}:'"
      delegate_to: "{{ vm_guest_ip }}"
      register: "network_conn_result"
      ignore_errors: true

    - name: "Set fact of network config file for '{{ network_adapter_name }}' on {{ vm_guest_os_distribution }}"
      ansible.builtin.set_fact:
        network_config_path: "{{ network_conn_properties[1] }}"
        network_connection_name: "{{ network_conn_properties[2] }}"
      vars:
        network_conn_properties: "{{ network_conn_result.stdout_lines[0].split(':') }}"
      when:
        - network_conn_result.rc is defined
        - network_conn_result.rc == 0
        - network_conn_result.stdout_lines | length == 1
        - network_conn_result.stdout_lines[0].split(':') | length == 3

- name: "Set fact of network config file for '{{ network_adapter_name }}' on {{ vm_guest_os_distribution }}"
  ansible.builtin.set_fact:
    network_config_path: "/etc/systemd/network/{{ network_adapter_name }}.network"
  when: guest_os_network_manager == "systemd-networkd"

# Set fact of network config file in guest OS except VMware Photon OS
- name: "Set fact of network config file"
  when: guest_os_network_manager not in ["NetworkManager", "systemd-networkd"]
  block:
    - name: "Set fact of network config file for '{{ network_adapter_name }}' on {{ vm_guest_os_distribution }}"
      ansible.builtin.set_fact:
        network_config_path: "/etc/sysconfig/network-scripts/ifcfg-{{ network_adapter_name }}"
      when: guest_os_family == "RedHat"

    - name: "Set fact of network config file for '{{ network_adapter_name }}' on Ubuntu desktop"
      ansible.builtin.set_fact:
        network_config_path: "/etc/network/interfaces"
      when: >
        (guest_os_ansible_distribution == "Debian") or
        (guest_os_ansible_distribution == "Pardus GNU/Linux") or
        (guest_os_ansible_distribution == "Ubuntu" and
         guest_os_network_manager != "netplan")

    - name: "Set fact of network config file in Ubuntu server"
      when:
        - guest_os_ansible_distribution == "Ubuntu"
        - guest_os_network_manager == "netplan"
      block:
        - name: "Get netplan config file in Ubuntu server"
          include_tasks: ../utils/get_netplan_config_file.yml

        - name: "Set fact of network config file for '{{ network_adapter_name }}' on Ubuntu server"
          ansible.builtin.set_fact:
            network_config_path: "{{ netplan_config_file }}"
          when: netplan_config_file is defined

    - name: "Set fact of network config file for '{{ network_adapter_name }}' on SLE"
      ansible.builtin.set_fact:
        network_config_path: "/etc/sysconfig/network/ifcfg-{{ network_adapter_name }}"
      when: guest_os_family == "Suse"

    - name: "Set fact of network config file for '{{ network_adapter_name }}' on FreeBSD"
      ansible.builtin.set_fact:
        network_config_path: "/etc/rc.conf"
      when: guest_os_family == "FreeBSD"

# The network config file must be set for the primary network interface or
# the second primary network interface which is not managed by NetworkManager
- name: "Check network config file is set"
  ansible.builtin.assert:
    that:
      - network_config_path
    fail_msg: >-
      Failed to get network config file of network adapter '{{ network_adapter_name }}'
      on {{ vm_guest_os_distribution }}
    success_msg: >-
      The network config file of network adapter '{{ network_adapter_name }}'
      is '{{ network_config_path }}' on {{ vm_guest_os_distribution }}
  when:
    network_adapter_is_primary | default(false) or
    guest_os_network_manager != "NetworkManager"
