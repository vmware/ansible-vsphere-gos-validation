# Copyright 2021-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Install, upgrade or uninstall packages in guest OS
# Parameters:
#   package_list: A list of packages to be installed, upgraded or uninstalled
#   package_state: The state of packages, which can be 'absent', 'installed', 'latest',
#     'present', 'removed'. Default is 'present'.
#     If package_state is 'present' or 'installed', missing packages in package_list will be installed.
#     If package_state is 'latest', installed packages in package_list will be upgraded, and missing
#       packages will be installed.
#     If package_state is 'absent' or 'removed', installed packages in package_list will be uninstalled.
#   package_repo_enable (optional): Default value is true, then it will configure guest OS package repositories.
#
- name: "Set default value of package_state to 'present'"
  ansible.builtin.set_fact:
    package_state: "present"
  when: package_state is undefined

- name: "Check parameters for installing or uninstalling package"
  ansible.builtin.assert:
    that:
      - package_list is defined
      - package_list | type_debug == 'list'
      - package_list | length > 0
      - package_state is defined
      - package_state in ['absent', 'installed', 'latest', 'present', 'removed']
    fail_msg: >-
      At least one of parameters 'package_list' and 'package_state' is incorrect.
      The value of 'package_list' is '{{ package_list | default("") }}'.
      The value of 'package_state' is '{{ package_state | default("") }}'.

- name: "Initialize variables for installing or uninstalling package"
  ansible.builtin.set_fact:
    package_manage_list: []

- name: "Get installed packages on {{ guest_os_ansible_distribution }}"
  include_tasks: get_installed_packages.yml

- name: "Set fact of packages which needs to be installed"
  ansible.builtin.set_fact:
    package_manage_list: "{{ package_list | difference(guest_installed_packages) }}"
    package_manage_op: "Install"
  when: package_state in ['installed', 'present']

- name: "Set fact of packages which needs to be installed with latest version"
  ansible.builtin.set_fact:
    package_manage_list: "{{ package_list }}"
    package_manage_op: "Install latest"
  when: package_state in ['latest']

- name: "Set fact of packages which needs to be uninstalled"
  ansible.builtin.set_fact:
    package_manage_list: "{{ package_list | select('in', guest_installed_packages) }}"
    package_manage_op: "Uninstall"
  when: package_state in ['absent', 'removed']

- name: "Display the pacakge list and operation"
  ansible.builtin.debug:
    msg:
      - "The package list is {{ package_manage_list }}"
      - "The package operation is {{ package_manage_op }}"

- name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }}"
  when: package_manage_list | length > 0
  block:
    - name: "Set proxy and add repositories for installing or upgrading package"
      when: package_state in ['installed', 'latest', 'present']
      block:
        - name: "Set proxy for installing package"
          include_tasks: set_proxy.yml

        - name: "Add OS release package repositories"
          when: package_repo_enable | default(true)
          block:
            - name: "Add a local repo from ISO image for {{ guest_os_ansible_distribution }}"
              include_tasks: ../utils/add_local_dvd_repo.yml
              when: guest_os_ansible_distribution in ['SLES', 'SLED', 'RedHat', 'Rocky',
                                                'AlmaLinux', 'openSUSE Leap']

            - name: "Add known online repos for other Linux OS"
              include_tasks: ../utils/add_official_online_repo.yml
              when: guest_os_ansible_distribution not in ['SLES', 'SLED', 'RedHat']

    - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }}"
      when: guest_os_ansible_distribution in ["VMware Photon OS", "FreeBSD"]
      block:
        - name: "Set facts of packages and command for VMware Photon OS"
          ansible.builtin.set_fact:
            package_manage_list_str: "{{ ' '.join(package_manage_list) }}"
            package_manager: |-
              {%- if guest_os_ansible_distribution == "VMware Photon OS" -%}tdnf
              {%- else -%}pkg
              {%- endif -%}

        - name: "Set the command to {{ package_manage_op | lower }} packages on {{ guest_os_ansible_distribution }}"
          ansible.builtin.set_fact:
            package_manage_cmd: |-
              {%- if package_state in [ 'installed', 'present', 'latest' ] -%}
                {{ package_manager }} install -y {{ package_manage_list_str }}
              {%- else -%}
                {{ package_manager }} remove -y {{ package_manage_list_str }}
              {%- endif -%}

        - name: "{{ package_manage_op }} packages on VMware Photon OS"
          ansible.builtin.command: "{{ package_manage_cmd }}"
          delegate_to: "{{ vm_guest_ip }}"
          register: package_manage_result

        - name: "Display the result of '{{ package_manage_cmd }}'"
          ansible.builtin.debug: var=package_manage_result

    - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }}"
      when: guest_os_family == "RedHat"
      block:
        - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
          ansible.builtin.yum:
            name: "{{ package_manage_list }}"
            allow_downgrade: true
            state: "{{ package_state }}"
          delegate_to: "{{ vm_guest_ip }}"
          when: guest_os_ansible_pkg_mgr | lower == "yum"

        - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
          when: guest_os_ansible_pkg_mgr | lower == "dnf"
          block:
            - name: "Get DNF version on {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
              ansible.builtin.shell: "dnf --version | head -n 1 | cut -d '.' -f 1"
              register: dnf_major_version_result
              ignore_errors: true
              delegate_to: "{{ vm_guest_ip }}"

            - name: "Set fact of DNF major version"
              ansible.builtin.set_fact:
                dnf_major_version: "{{ dnf_major_version_result.stdout }}"
              when:
                - dnf_major_version_result.rc is defined
                - dnf_major_version_result.rc | int == 0
                - dnf_major_version_result.stdout is defined
                - dnf_major_version_result.stdout

            - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
              ansible.builtin.dnf:
                name: "{{ package_manage_list }}"
                allow_downgrade: true
                state: "{{ package_state }}"
                use_backend: |-
                  {%- if dnf_major_version | default('') and dnf_major_version | int >= 4 -%}{{ 'dnf' + dnf_major_version }}
                  {%- else -%}auto{%- endif -%}
              delegate_to: "{{ vm_guest_ip }}"

    - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
      community.general.zypper:
        name: "{{ package_manage_list }}"
        state: "{{ package_state }}"
      delegate_to: "{{ vm_guest_ip }}"
      when: guest_os_family == "Suse"

    - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }}"
      when: guest_os_family in ["Debian", "Astra Linux (Orel)"]
      block:
        - name: "Remove dpkg lock file"
          include_tasks: remove_dpkg_lock_file.yml

        - name: "{{ package_manage_op }} packages on {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
          ansible.builtin.apt:
            name: "{{ package_manage_list }}"
            state: "{{ package_state }}"
            update_cache: "{{ guest_os_family == 'Debian' }}"
          delegate_to: "{{ vm_guest_ip }}"
