# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Enable auto login for user
# Parameter:
#   autologin_user: The username to auto login
#   autologin_delay: (Optional)Time to wait before the user is auto logged in.

- name: "Set default delay time to 0s before user auto login"
  ansible.builtin.set_fact:
    autologin_delay: 0
  when: autologin_delay is undefined or not autologin_delay

- name: "Initialize facts for enabling auto login"
  ansible.builtin.set_fact:
    enable_autologin: false
    dm_conf_file: ""

- name: "Set GNOME configuration file path"
  block:
    - name: "Set GNOME configuration file for {{ guest_os_ansible_distribution }}"
      ansible.builtin.set_fact:
        dm_conf_path: "/etc/gdm/custom.conf"
      when: guest_os_family == "RedHat"
    
    - name: "Set GNOME configuration file for {{ guest_os_ansible_distribution }}"
      ansible.builtin.set_fact:
        dm_conf_path: "/etc/sysconfig/displaymanager"
      when: guest_os_family == "Suse"
    
    - name: "Set GNOME configuration file for Ubuntu"
      ansible.builtin.set_fact:
        dm_conf_path: "/etc/gdm3/custom.conf"
      when: guest_os_ansible_distribution == "Ubuntu"
    
    - name: "Set GNOME configuration file for Debian"
      ansible.builtin.set_fact:
        dm_conf_path: "/etc/gdm3/daemon.conf"
      when: guest_os_ansible_distribution == "Debian"
  when: guest_os_display_manager == "gdm"

- name: "Set LightDM configuration file path"
  ansible.builtin.set_fact:
    dm_conf_path: "/etc/lightdm/lightdm.conf"
  when: guest_os_display_manager == "lightdm"

- name: "Set FLY-DM configuration file path"
  ansible.builtin.set_fact:
    dm_conf_path: "/etc/X11/fly-dm/fly-dmrc"
  when: guest_os_display_manager == "fly-dm"

- name: "Check display manager configuration file status"
  ansible.builtin.stat:
    path: "{{ dm_conf_path }}"
  register: dm_stat_result
  delegate_to: "{{ vm_guest_ip }}"

- name: "{{ dm_conf_path }} exists. Auto login can be enabled"
  ansible.builtin.set_fact:
    enable_autologin: true
  when:
    - dm_stat_result is defined
    - dm_stat_result.stat is defined
    - dm_stat_result.stat.exists is defined
    - dm_stat_result.stat.exists

- name: "Enable auto login for user {{ autologin_user }}"
  block:
    - name: "Enable GNOME auto login for user {{ autologin_user }} in {{ guest_os_ansible_distribution }}"
      block:
        - include_tasks: ../../common/update_ini_style_file.yml
          vars:
            file_path: "{{ dm_conf_path }}"
            section_name: "daemon"
            option_name: "{{ item[0] }}"
            option_value: "{{ item[1] }}"
          with_list:
            - ["AutomaticLogin", "{{ autologin_user }}"]
            - ["AutomaticLoginEnable", "True"]
      when:
        - guest_os_display_manager == "gdm"
        - guest_os_family in ["RedHat", "Debian"]
    
    # Enable auto login for SLES/SLED
    - name: "Enable GNOME autologin for {{ guest_os_ansible_distribution }}"
      include_tasks: replace_or_add_line_in_file.yml
      vars:
        file: "{{ dm_conf_path }}"
        reg_exp: "DISPLAYMANAGER_AUTOLOGIN=.*"
        line_content: "DISPLAYMANAGER_AUTOLOGIN={{ autologin_user }}"
      when:
        - guest_os_display_manager == "gdm"
        - guest_os_ansible_distribution in ["SLES", "SLED"]

    - name: "Enable LightDM autologin for {{ guest_os_ansible_distribution }}"
      block:
        - include_tasks: ../../common/update_ini_style_file.yml
          vars:
            file_path: "{{ dm_conf_path }}"
            section_name: "Seat:*"
            option_name: "{{ item[0] }}"
            option_value: "{{ item[1] }}"
          with_list:
            - ['autologin-user', '{{ autologin_user }}']
            - ['autologin-user-timeout', '{{ autologin_delay }}']
      when: guest_os_display_manager == "lightdm"

    - name: "Enable FLY-DM autologin for {{ guest_os_ansible_distribution }}"
      block:
        - include_tasks: ../../common/update_ini_style_file.yml
          vars:
            file_path: "{{ dm_conf_path }}"
            section_name: "X-:0-Core"
            option_name: "{{ item[0] }}"
            option_value: "{{ item[1] }}"
          with_items:
            - ["AutoLoginEnable", "true"]
            - ["AutoLoginUser", "{{ autologin_user }}"]
      when: guest_os_display_manager == "fly-dm"
  when: enable_autologin
