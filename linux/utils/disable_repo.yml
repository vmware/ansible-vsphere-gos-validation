# Copyright 2021-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Disable a package reposiotory
# Parameter
#   guest_repo_list(Optional): A list of repo names to disable. By default, all repos will be disabled

- name: "Get enabled repositories list on {{ vm_guest_os_distribution }}"
  when:
    - guest_os_family == 'RedHat'
    - guest_repo_list is undefined
  block:
    - name: "List all yum repositories"
      ansible.builtin.shell: "yum repolist 2>/dev/null | grep -v 'repo id.*repo name' | awk '{print $1}'"
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true
      register: yum_repo_list_result

    - name: "Set fact of the repo list"
      ansible.builtin.set_fact:
        guest_repo_list: "{{ yum_repo_list_result.stdout_lines | select }}"
      when:
        - not yum_repo_list_result.failed
        - yum_repo_list_result.stdout_lines

- name: "Disable all repositories"
  when: guest_repo_list is undefined or guest_repo_list | length == 0
  block:
    # RHEL-like OS
    - name: "Disable all yum repositories"
      ansible.builtin.shell: "sed -i 's/enabled *= *1/enabled=0/' /etc/yum.repos.d/*.repo"
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true
      when: guest_os_family == 'VMware Photon OS'

    # SUSE
    - name: "Disable all zypper repositories"
      ansible.builtin.shell: "sed -i 's/enabled *= *1/enabled=0/' /etc/zypp/repos.d/*.repo"
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true
      when: guest_os_family == "Suse"

- name: "Disable guest OS repositories"
  when: guest_repo_list | length > 0
  block:
    # RHEL-like OS
    - name: "Disable repositories for {{ vm_guest_os_distribution }}"
      when: guest_os_family == 'RedHat'
      block:
        - name: "Disable yum repository"
          ansible.builtin.command: "yum-config-manager --disable {{ item }}"
          delegate_to: "{{ vm_guest_ip }}"
          with_items: "{{ guest_repo_list }}"
          when: guest_os_ansible_pkg_mgr == "yum"

        - name: "Disable yum repository"
          ansible.builtin.command: "dnf config-manager --set-disabled {{ item }}"
          delegate_to: "{{ vm_guest_ip }}"
          with_items: "{{ guest_repo_list }}"
          when: guest_os_ansible_pkg_mgr in ["dnf", "dnf5"]

    # VMware Photon OS
    - name: "Disable yum repository {{ item }}"
      ansible.builtin.shell: "grep -l '\\[{{ item }}\\]' /etc/yum.repos.d/*.repo | xargs sed -i 's/enabled *= *1/enabled=0/'"
      delegate_to: "{{ vm_guest_ip }}"
      with_items: "{{ guest_repo_list }}"
      when: guest_os_ansible_distribution == 'VMware Photon OS'

    # SUSE
    - name: "Disable zypper repository {{ item }}"
      ansible.builtin.command: "zypper mr -d {{ item }}"
      delegate_to: "{{ vm_guest_ip }}"
      with_items: "{{ guest_repo_list }}"
      when: guest_os_family == "Suse"
