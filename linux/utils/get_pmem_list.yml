# Copyright 2022-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   Get a list of PMem devices in guest OS
# Return:
#   guest_pmem_list: A list of PMem devices
#
- name: "Initialize the fact of device list"
  ansible.builtin.set_fact:
    guest_pmem_list: []

- name: "Check command 'ndctl' exists"
  ansible.builtin.shell: "which ndctl"
  ignore_errors: true
  delegate_to: "{{ vm_guest_ip }}"
  register: check_ndctl_result

- name: "Install 'ndctl' for managing PMem devices"
  include_tasks: install_uninstall_package.yml
  vars:
    package_list: ["ndctl"]
    package_state: "present"
  when: >-
    check_ndctl_result is undefined or
    check_ndctl_result.rc is undefined or
    check_ndctl_result.rc != 0

- name: "Get PMem devices in guest OS"
  ansible.builtin.shell: "ndctl list -DHR"
  delegate_to: "{{ vm_guest_ip }}"
  changed_when: false
  ignore_errors: true
  register: ndctl_list_result

- name: "Set the fact of PMem devices info"
  when:
    - ndctl_list_result is defined
    - ndctl_list_result.stdout is defined
    - ndctl_list_result.stdout
    - ndctl_list_result.stdout | from_json | length == 2
  block:
    - name: "Set the fact of PMem DIMMs and namespaces info"
      ansible.builtin.set_fact:
        guest_dimms_and_regions: "{{ ndctl_list_result.stdout | from_json }}"
        guest_dimms_list: []
        guest_regions_mappings: []

    - name: "Get PMem devices list"
      when:
        - guest_dimms_and_regions.dimms is defined
        - guest_dimms_and_regions.dimms | length > 0
      block:
        - name: "Set fact of PMem DIMMs list"
          ansible.builtin.set_fact:
            guest_dimms_list: "{{ guest_dimms_and_regions.dimms }}"

        - name: "Set fact of PMem regions mappings"
          ansible.builtin.set_fact:
            guest_regions_mappings: "{{ guest_dimms_and_regions.regions | map(attribute='mappings') | flatten }}"
          when:
            - guest_dimms_and_regions.regions is defined
            - guest_dimms_and_regions.regions | length > 0

        - name: "Check all PMem DIMMs are mapped to regions"
          ansible.builtin.assert:
            that:
              - guest_regions_mappings | length == guest_dimms_list | length
            fail_msg: >-
              Not all DIMMs are mapped to a region. Current DIMMs list is {{ guest_dimms_list }}, regions mappings
              are {{ guest_regions_mappings }}.

        - name: "Update PMem devices size"
          ansible.builtin.set_fact:
            guest_pmem_list: >-
              {{
                guest_pmem_list +
                [
                 item |
                 combine({'blockdev': item.dev | replace('nmem', 'pmem'), 'length': 0}) |
                 combine(guest_regions_mappings | selectattr('dimm', 'equalto', item.dev) | first)
                ]
              }}
          with_items: "{{ guest_dimms_list }}"

- name: "Print guest PMem device list"
  ansible.builtin.debug: var=guest_pmem_list
