# Copyright 2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   Check VC SSO user's SAML token munged (signature value is replaced) and token is verified by host
# in VGAuthService log file
# Parameter:
#   vgauth_log_path_local: The collected VGAuthService log file at localhost
#
- name: "Initialize facts of checking VGAuthServcie log"
  ansible.builtin.set_fact:
    saml_token_is_munged: false
    saml_token_is_host_verified: false

- name: "Check VC SSO user's SAML token signature value is replaced"
  ansible.builtin.shell:
    cmd: "grep -c '<ds:SignatureValue>JUhPU1RfVkVSSUZJRURfU0lHTkFUVVJFJQA=</ds:SignatureValue>' '{{ vgauth_log_path_local }}'"
  ignore_errors: true
  register: check_sign_value_result

- name: "Set fact of SAML token is munged"
  ansible.builtin.set_fact:
    saml_token_is_munged: true
  when:
    - check_sign_value_result.rc is defined
    - check_sign_value_result.rc == 0
    - check_sign_value_result.stdout is defined
    - check_sign_value_result.stdout.strip() == '1'

- name: "Check VC SSO user's SAML token is verified by host and skipped by guest OS"
  ansible.builtin.shell:
    cmd: "grep -c 'VerifySignature: token is hostVerified, skipping signature check' '{{ vgauth_log_path_local }}'"
  ignore_errors: true
  register: check_host_verified_result

- name: "Set fact of SAML token is host verified"
  ansible.builtin.set_fact:
    saml_token_is_host_verified: true
  when:
    - check_host_verified_result.rc is defined
    - check_host_verified_result.rc == 0
    - check_host_verified_result.stdout is defined
    - check_sign_value_result.stdout.strip() == '1'

- name: "Assert SAML token is verified by host"
  ansible.builtin.assert:
    that:
      - saml_token_is_munged | bool
      - saml_token_is_host_verified | bool
    fail_msg: >-
      Failed to verify VC SSO user's SAML token by host.
      The result of searching munged signature value 'JUhPU1RfVkVSSUZJRURfU0lHTkFUVVJFJQA=' is
      {{ saml_token_is_munged }}.
      The result of searching host verified SAML token is {{ saml_token_is_host_verified }}.
    success_msg: "VC SSO user's SAML token is verified by host"
