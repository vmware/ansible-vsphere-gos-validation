# Copyright 2021 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Fetch gosc log file to local and check the log content
- name: "Set guest customization plugin log location on localhost"
  set_fact:
    deploypkg_log_path: "{{ testcase_info_collect_path }}{{ gosc_deploypkg_log_file }}"
    gosc_log_success: True

- include_tasks: ../../common/vm_guest_file_operation.yml
  vars:
    operation: "fetch_file"
    src_path: "{{ gosc_deploypkg_log_file }}"
    dest_path: "{{ deploypkg_log_path }}"

# Check perl GOSC log file
- block:
    # Check below message exists
    - include_tasks: check_log_msg.yml
      vars:
        check_log_file: "{{ deploypkg_log_path }}"
        check_msg_state: "present"
      with_items:
        - "Executing traditional GOSC workflow"
        - "Deployment succeeded"
        - "Ran DeployPkg_DeployPackageFromFile successfully"
      loop_control:
        loop_var: "check_msg_regexp"

    # Check below message doesn't exist
    - include_tasks: check_log_msg.yml
      vars:
        check_log_file: "{{ deploypkg_log_path }}"
        check_msg_regexp: "uncaught signal 15"
        check_msg_state: "absent"
  when: gosc_workflow == "perl"

# Check cloud-init GOSC log file
- block:
    # Collect /var/log/cloud-init.log and /etc/cloud/cloud.cfg
    - include_tasks: ../../common/vm_guest_file_operation.yml
      vars:
        operation: "fetch_file"
        src_path: "{{ item }}"
        dest_path: "{{ testcase_info_collect_path }}{{ item }}"
      with_items:
        - "{{ gosc_cloudinit_log_file }}"
        - "/etc/cloud/cloud.cfg"

    # Check below message exists
    - include_tasks: check_log_msg.yml
      vars:
        check_log_file: "{{ deploypkg_log_path }}"
        check_msg_state: "present"
      with_items:
        - "Executing cloud-init workflow"
        - "Deployment for cloud-init succeeded"
        - "Ran DeployPkg_DeployPackageFromFile successfully"
      loop_control:
        loop_var: "check_msg_regexp"
  when: gosc_workflow == "cloud-init"

- name: "Print GOSC log file check result"
  debug: var=gosc_log_success
