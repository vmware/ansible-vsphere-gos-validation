# Copyright 2026 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Hash testing using TPM 2.0
#
- name: "Prepare test data"
  ansible.builtin.shell: echo "Hello_vTPM_Hash" > test_hash_data.txt
  delegate_to: "{{ vm_guest_ip }}"

- name: "Perform hash operation on the file with TPM in {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
  ansible.builtin.shell: tpm2_hash -T device -H o -g sha256 -o hash.out test_hash_data.txt
  delegate_to: "{{ vm_guest_ip }}"
  when: tpm2_major_version is defined and tpm2_major_version | int < 4

- name: "Perform hash operation on the file with TPM in {{ guest_os_ansible_distribution }} {{ guest_os_ansible_distribution_ver }}"
  ansible.builtin.shell: tpm2_hash -C o -g sha256 -o hash.out test_hash_data.txt
  delegate_to: "{{ vm_guest_ip }}"
  when: tpm2_major_version is defined and tpm2_major_version | int >= 4

- name: "Check the Hash"
  ansible.builtin.shell: hexdump -C hash.out
  delegate_to: "{{ vm_guest_ip }}"

