# Copyright 2025 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
#
- name: "Install 'tpm2-tools' for {{ guest_os_ansible_distribution }}"
  include_tasks: ../utils/install_uninstall_package.yml
  vars:
    package_list: ["tpm2-tools"]
    package_state: "present"
  when: guest_os_ansible_distribution not in ['SLES', 'SLED', 'openSUSE Leap']

# Configure local DVD repositories to install packages for openSUSE, SLES.
- name: "Add ISO repo and install packages from ISO"
  when: guest_os_ansible_distribution in ['SLES', 'SLED', 'openSUSE Leap']
  block:
    - name: "Connect CDROM and add local repositories on {{ vm_guest_os_distribution }}"
      include_tasks: ../utils/add_local_dvd_repo.yml
      when:
        - os_installation_iso_list is defined
        - os_installation_iso_list | length > 0

    - name: "Install packages for {{ guest_os_ansible_distribution }}"
      include_tasks: ../utils/install_uninstall_package.yml
      vars:
        package_list: ["tpm2-tss-engine-devel", "tpm2.0-tools", "tpm2.0-abrmd"]
        package_state: "present"

- name: "Get tpm2-tools version"
  ansible.builtin.shell: tpm2_getcap --version
  delegate_to: "{{ vm_guest_ip }}"
  register: tpm_tools_version_result

- name: "Print tpm2-tools version"
  ansible.builtin.debug: var=tpm_tools_version_result

- name: Set tpm2-tools major version fact
  ansible.builtin.set_fact:
    tpm2_major_version: "{{ tpm_tools_version_result.stdout | regex_search('version=\"([0-9]+)\\.', '\\1') }}"

- name: "Install package openssl for {{ guest_os_ansible_distribution }}"
  include_tasks: ../utils/install_uninstall_package.yml
  vars:
    package_list: ["openssl"]
    package_state: "present"
  when: guest_os_ansible_distribution == "Fedora"
