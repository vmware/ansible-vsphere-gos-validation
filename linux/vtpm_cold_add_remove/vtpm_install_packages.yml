# Copyright 2026 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
- name: "Set fact of packages list required by vTPM"
  ansible.builtin.set_fact:
    vtpm_package_list: |-
      {%- if guest_os_ansible_distribution in ['SLES', 'SLED', 'openSUSE Leap'] -%}['tpm2-tss-engine-devel', 'tpm2.0-tools', 'tpm2.0-abrmd']
      {%- elif  guest_os_ansible_distribution == 'Fedora' -%}['tpm2-tools', 'openssl']
      {%- else -%}['tpm2-tools']{%- endif -%}

- name: "Set fact of packages list required by vTPM in Canonical Cloud Image"
  ansible.builtin.set_fact:
    vtpm_package_list: "{{ vtpm_package_list + ['bsdextrautils'] }}"
  when:
    - guest_os_ansible_distribution == "Ubuntu"
    - guest_os_edition is defined
    - guest_os_edition == "CloudImage"

- name: "Install packages for {{ guest_os_ansible_distribution }}"
  include_tasks: ../utils/install_uninstall_package.yml
  vars:
    package_list: "{{ vtpm_package_list }}"
    package_state: "present"

- name: "Initialize fact of tpm2-tools major version"
  ansible.builtin.set_fact:
    tpm2_major_version: "0"

- name: "Get tpm2-tools version"
  ansible.builtin.shell: tpm2_getcap --version
  delegate_to: "{{ vm_guest_ip }}"
  register: tpm_tools_version_result

- name: "Print tpm2-tools version"
  ansible.builtin.debug: var=tpm_tools_version_result

- name: "Set fact of tpm2-tools major version for {{ guest_os_ansible_distribution }}"
  ansible.builtin.set_fact:
    tpm2_major_version: "{{ (tpm_tools_version_result | regex_search('version=\"([0-9]+)', '\\1'))[0] }}"
  when: guest_os_ansible_distribution != "Kylin Linux Advanced Server"

- name: "Get TPM version for {{ guest_os_ansible_distribution }}"
  when: guest_os_ansible_distribution == "Kylin Linux Advanced Server"
  block:
    - name: "Get TPM version from tpm2-tools package"
      ansible.builtin.shell: "rpm -qa | grep '^tpm2-tools-[0-9]'"
      delegate_to: "{{ vm_guest_ip }}"
      register: tpm_tools_version_result

    - name: "Set fact of tpm2-tools major version"
      ansible.builtin.set_fact:
        tpm2_major_version: "{{ (tpm_tools_version_result | regex_search('tpm2-tools-([0-9]+)', '\\1'))[0] }}"

- name: "Print tpm2-tools major version"
  ansible.builtin.debug: var=tpm2_major_version
