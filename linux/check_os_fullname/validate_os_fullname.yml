# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Wait VMware tools to report Guest OS fullname
- name: "Get VM's guest info"
  include_tasks: ../../common/vm_get_guest_info.yml

# If the guest os full name is unmapped and displays OS detailed data, test passed
- name: "Guest OS full name is unmapped but shows OS detailed data"
  block:
    - name: "guest OS detailed information is shown in guest OS full name, test passed"
      ansible.builtin.meta: end_host
  when:
    - (esxi_version is version('6.7.0', '==') and (esxi_update_version | int < 2)) or (esxi_version is version('7.0.0', '=='))
    - unmapped_os_fullname is defined and unmapped_os_fullname
    - unmapped_os_fullname in guestinfo_guest_full_name

- name: "Check guest ID in guest info is not empty"
  ansible.builtin.assert:
    that:
      - guestinfo_guest_id
    fail_msg: "Guest ID in guest info is '{{ guestinfo_guest_id }}', which should be a valid value firstly."

- name: "Display VM's guest OS full name and expected guest OS full name"
  ansible.builtin.debug:
    msg:
      - "VM's guest OS full name is '{{ guestinfo_guest_full_name }}'."
      - "Expected guest OS full name is '{{ expected_guest_fullname }}'."

- name: "Validate Guest OS full name is {{ expected_guest_fullname[0] }} or {{ expected_guest_fullname[1] }}"
  ansible.builtin.assert:
    that:
      - guestinfo_guest_full_name in expected_guest_fullname
    fail_msg: >
      VM's guest OS full name is: '{{ guestinfo_guest_full_name }}',
      not expected '{{ expected_guest_fullname[0] }}' or '{{ expected_guest_fullname[1] }}'
  when:
    - expected_guest_fullname is sequence
    - expected_guest_fullname | length == 2

- name: "Validate Guest OS full name is {{ expected_guest_fullname }}"
  ansible.builtin.assert:
    that:
      - guestinfo_guest_full_name == expected_guest_fullname
    fail_msg: >
      VM's guest OS full name is: '{{ guestinfo_guest_full_name }}',
      not expected '{{ expected_guest_fullname }}'
  when: expected_guest_fullname is string
