# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Map Flatcar, RockyLinux, or other Linux distribution which doesn't have a unique guest id

# If there is no best match of the guest full name on ESXi server, it will show the guest OS detailed information
# in the guest full name, which include the kernel version and os distribution
- name: "Set unmapped guest fullname for {{ vm_guest_os_distribution }} on on ESXi {{ esxi_version }}"
  ansible.builtin.set_fact:
    unmapped_os_fullname: "Linux {{ guest_os_ansible_kernel }} {{ guest_os_ansible_distribution }}"

- name: "Set fact of Linux kernel major version"
  ansible.builtin.set_fact:
    linux_kernel_major_ver: "{{ guest_os_ansible_kernel | regex_search('^\\d+') }}"

- name: "Fail the test due to unknown Linux kernel major version"
  ansible.builtin.fail:
    msg: "Failed to extract major version from Linux kernel version {{ guest_os_ansible_kernel }}"
  when: not linux_kernel_major_ver

# Linux kernel >= 5.x
- name: "Set expected_guest_id and expected_guest_fullname with VM's guest OS version on ESXi {{ esxi_version }}"
  ansible.builtin.set_fact:
    expected_guest_id: "{{ vm_guest_id }}"
    expected_guest_fullname: "{{ vm_guest_os_version }}"
  when:
    - linux_kernel_major_ver | int >= 5
    - esxi_version is version('7.0.0', '<=')

- name: "Set fact of expected guest OS major version on ESXi {{ esxi_version }}"
  ansible.builtin.set_fact:
    expected_guest_major_ver: |-
      {%- if esxi_version is version('6.7.0', '<') -%}
      {{ [linux_kernel_major_ver | int, 3] | min }}
      {%- elif esxi_version is version('6.7.0', '>=') and esxi_version is version('7.0.1', '<') -%}
      {{ [linux_kernel_major_ver | int, 4 ] | min }}
      {%- elif esxi_version is version('7.0.1', '>=') and esxi_version is version('8.0.0', '<') -%}
      {{ [linux_kernel_major_ver | int, 5 ] | min }}
      {%- elif esxi_version is version('8.0.0', '>=') -%}
      {{ [linux_kernel_major_ver | int, 6 ] | min }}
      {%- endif %}


- name: "Set expected_guest_id and expected_guest_fullname for {{ vm_guest_os_distribution }} on ESXi {{ esxi_version }}"
  ansible.builtin.set_fact:
    expected_guest_id: "other{{ expected_guest_major_ver }}xLinux{{ expected_guest_id_suffix }}"
    expected_guest_fullname: "Other {{ expected_guest_major_ver }}.x or later Linux ({{ guest_os_bit }})"

