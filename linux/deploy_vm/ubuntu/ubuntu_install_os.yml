# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Start to Ubuntu OS install
- include_tasks: ./ubuntu_autoinstall.yml
  when: ubuntu_install_method is defined and ubuntu_install_method == "simulation"

# Wait for autoinstall start message in serial port output file
- name: "Wait for Ubuntu autoinstall is started successfully"
  when: unattend_installer == 'Ubuntu-Subiquity'
  block:
    - name: "Wait for Ubuntu autoinstall start message"
      include_tasks: ../../../common/wait_vm_deploy_checkpoint.yml
      vars:
        wait_checkpoint_name: "autoinstall_start"
        wait_checkpoint_log_file: "{{ vm_serial_file_name }}"
        wait_checkpoint_msg: "{{ autoinstall_start_msg }}[^\\r\\n]*"
        wait_checkpoint_delay: 10
        wait_checkpoint_retires: 150

    # Ubuntu autoinstall with cloud configs requires network connection.
    # When autoinstall start message is detected, its must be followed with an IPv4
    # address get at early-commands in the unattend install config file.
    # Otherwise, we can stop autoinstall immediately.
    - name: "Get the IPv4 address when Ubuntu autoinstall started"
      ansible.builtin.set_fact:
        ubuntu_autoinstall_start_ipv4: >-
          {{
            checkpoint_msg_list |
            map('replace', autoinstall_start_msg, '') |
            map('trim') |
            ansible.utils.ipaddr('address')
          }}

    - name: "Check VM obtains IPv4 address"
      ansible.builtin.assert:
        that:
          - ubuntu_autoinstall_start_ipv4
          - ubuntu_autoinstall_start_ipv4 | length > 0
          - ubuntu_autoinstall_start_ipv4[0] is ansible.utils.ipv4
        fail_msg: "Ubuntu autoinstall failed to start due to no IPv4 address obtained."
        success_msg: "Ubuntu autoinstall is started with IPv4 address {{ ubuntu_autoinstall_start_ipv4 }}"
