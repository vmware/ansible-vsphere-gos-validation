# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Start to Ubuntu OS install
- include_tasks: ./ubuntu_autoinstall.yml
  when: ubuntu_install_method == "simulation"

- block:
    - name: "Wait for autoinstall early commands"
      command: "grep -c -e '{{ autoinstall_start_msg }}' {{ vm_serial_port_output_file }}"
      until:
        - autoinstall_started is defined
        - autoinstall_started.stdout is defined
        - autoinstall_started.stdout == "1"
      delay: 5
      retries: 150
      delegate_to: "{{ esxi_hostname }}"
      register: autoinstall_started

    - include_tasks: ../../../common/vm_wait_guest_ip.yml

    - name: Sleep 200 seconds to wait confirm message for ubuntu
      pause:
        seconds: 200

    - include_tasks: ../../../common/vm_guest_send_key.yml
      vars:
        keys_send:
          - ENTER
        string_send: 'yes'
    - include_tasks: ../../../common/vm_guest_send_key.yml
      vars:
        keys_send:
          - ENTER
  when: ubuntu_install_method == "cloud-init"
