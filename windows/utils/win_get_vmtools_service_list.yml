# Copyright 2021-2026 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Get VMware Tools installed services in Windows guest OS.
# Return:
#   vmtools_service_dict: VMware Tools services and their status dict.
#
- name: "Initialize VMware Tools services dict"
  ansible.builtin.set_fact:
    vmtools_service_dict: {}

- name: "Get VMware Tools services in guest OS"
  ansible.windows.win_shell: "Get-Service | Where-Object {$_.displayname -match 'VMware'} | select Name, Status | ft -hide"
  register: get_vmtools_service_result
  ignore_errors: true
  delegate_to: "{{ vm_guest_ip }}"
  ignore_unreachable: true

- name: "Set fact of VMware Tools services dict"
  ansible.builtin.set_fact:
    vmtools_service_dict: "{{ vmtools_service_dict | combine({item.split()[0]: item.split()[1]}) }}"
  with_items: "{{ get_vmtools_service_result.stdout_lines | default([]) | select }}"

- name: "Display VMware Tools services dict"
  ansible.builtin.debug: var=vmtools_service_dict
