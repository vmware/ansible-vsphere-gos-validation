# Copyright 2021 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Windows Update will cause poweroff or restart taking a long time,
# or GOSC test cases failure, so here try to disable Windows Update
# and pause update 10 days.
# 
- name: Set fact of the Windows Update registry path
  set_fact:
    win_update_reg_path: "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU"
# Check if this path exists
- include_tasks: win_execute_cmd.yml
  vars:
    win_powershell_cmd: "Test-Path -Path '{{ win_update_reg_path }}'"

- name: Set fact of disable Windows Auto Update registry key
  set_fact:
    guest_disable_wu: "New-Item -Path '{{ win_update_reg_path }}' -Force | New-ItemProperty -Name 'NoAutoUpdate' -PropertyType DWORD -Value 1"
  when: win_powershell_cmd_output.stdout_lines[0] != "True"
- name: Set fact of disable Windows Auto Update registry key
  set_fact:
    guest_disable_wu: "New-ItemProperty -Path '{{ win_update_reg_path }}' -Name 'NoAutoUpdate' -PropertyType DWORD -Value 1 -Force"
  when: win_powershell_cmd_output.stdout_lines[0] == "True"

- include_tasks: win_execute_cmd.yml
  vars:
    win_powershell_cmd: "{{ guest_disable_wu }}"

# Get current date time in guest OS
- include_tasks: win_execute_cmd.yml
  vars:
    win_powershell_cmd: "(Get-Date).ToUniversalTime().ToString('yyyy-MM-ddTHH:mm:ssZ')"
- name: Set fact of the current date
  set_fact:
    guest_current_date: "{{ win_powershell_cmd_output.stdout_lines[0] }}"

# Get date time after 10 days from current date time
- include_tasks: win_execute_cmd.yml
  vars:
    win_powershell_cmd: "(Get-Date).AddDays(10).ToUniversalTime().ToString('yyyy-MM-ddTHH:mm:ssZ')"
- name: "Set fact of 10 days after current date"
  set_fact:
    guest_ten_days_after: "{{ win_powershell_cmd_output.stdout_lines[0] }}"

- debug:
    msg: "Will pause Windows Update from '{{ guest_current_date }}' to '{{ guest_ten_days_after }}'."
- block:
    - debug:
        msg: "Set pauing Windows Update through registry 'HKLM:\\SOFTWARE\\Microsoft\\WindowsUpdate\\UX\\Settings'"
    - name: Set fact of registry keys for pausing Windows Update
      set_fact:
        guest_registry_keys:
          - "'PauseUpdatesExpiryTime' -Value {{ guest_ten_days_after }}"
          - "'PauseFeatureUpdatesStartTime' -Value {{ guest_current_date }}"
          - "'PauseFeatureUpdatesEndTime' -Value {{ guest_ten_days_after }}"
          - "'PauseQualityUpdatesStartTime' -Value {{ guest_current_date }}"
          - "'PauseQualityUpdatesEndTime' -Value {{ guest_ten_days_after }}"
    - include_tasks: win_execute_cmd.yml
      vars:
        win_powershell_cmd: "Set-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\WindowsUpdate\\UX\\Settings' -Name {{ added_key }}"
      with_items: "{{ guest_registry_keys }}"
      loop_control:
        loop_var: added_key
  when:
    - guest_current_date is defined and guest_current_date
    - guest_ten_days_after is defined and guest_ten_days_after
