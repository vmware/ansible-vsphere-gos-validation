# Copyright 2021-2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Execute specified powershell command in Windows guest OS
# Parameters:
#   win_powershell_cmd: powershell command
#   win_execute_cmd_ignore_error: True or False
# Return:
#   win_powershell_cmd_output
#
- name: Check required parameter
  assert:
    that:
      - win_powershell_cmd is defined
      - win_powershell_cmd
    fail_msg: "win_powershell_cmd is not defined"

- name: "Execute powershell command '{{ win_powershell_cmd }}'"
  win_shell: "{{ win_powershell_cmd }}"
  register: win_powershell_cmd_output
  ignore_errors: "{{ win_execute_cmd_ignore_error | default(False) }}"
  delegate_to: "{{ vm_guest_ip }}"
  ignore_unreachable: True

- block:
    - name: Test connection to VM
      command: ping -c 10 "{{ vm_guest_ip }}"
      register: ping_vm_result
      changed_when: false
      ignore_errors: true
    - debug: var=ping_vm_result
    - name: Test connection into guest
      setup:
        filter: "ansible_all_ipv4_addresses"
      register: setup_vm_connection
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true
    - debug: var=setup_vm_connection
    - name: "Guest OS unreachable"
      fail:
        msg: "{{ win_powershell_cmd_output }}"
  when:
    - win_powershell_cmd_output is defined
    - win_powershell_cmd_output.unreachable is defined
    - win_powershell_cmd_output.unreachable

- name: Display the powershell commmand result
  debug: var=win_powershell_cmd_output
  when: enable_debug is defined and enable_debug
