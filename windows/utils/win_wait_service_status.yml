# Copyright 2022-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Retry to get serivce status in Windows guest OS until it reaches the expected state.
# Parameters:
#   win_service_name: the service name to getting status.
#   win_wait_service_state (optional): the state of the service, e.g., 'Stopped', 'Running'.
#     Default value is 'Running'.
#   win_wait_service_timeout (optional): the timeout in seconds to wait for service state.
#     Default value is 60s.
#
- name: "Check required parameter"
  ansible.builtin.assert:
    that:
      - win_service_name is defined
      - win_service_name | length > 0
    msg: "Parameter 'win_service_name' must be defined before get service status."

- name: "Check specified service '{{ win_service_name }}' status in Windows"
  ansible.windows.win_shell: 'Get-Service -Name {{ win_service_name }} | foreach {$_.Status}'
  delegate_to: "{{ vm_guest_ip }}"
  register: get_service_status
  delay: 5
  retries: "{{ (win_wait_service_timeout | default(60) / 5) | round | int }}"
  until:
    - get_service_status is defined
    - get_service_status.stdout_lines is defined
    - get_service_status.stdout_lines | length == 1
    - get_service_status.stdout_lines[0] == win_wait_service_state | default('Running')
  ignore_errors: true
  ignore_unreachable: true

- name: "Check service '{{ win_service_name }}' status in Windows"
  ansible.builtin.assert:
    that:
      - get_service_status.failed is defined
      - not get_service_status.failed
    fail_msg: >-
      Windows service '{{ win_service_name }}' status is not {{ win_wait_service_state | default('Running') }}
      after {{ win_wait_service_timeout | default(60) }} seconds.
      Get service status in guest OS '{{ get_service_status.stdout_lines | default("") }}'.
