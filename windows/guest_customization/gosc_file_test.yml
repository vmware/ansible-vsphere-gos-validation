# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   This test case is used for check guest customization with DHCP
# network configuration. If VMware tools is not installed, the test
# result is 'No Run'.
# Note: VM guest customization requires vCenter server.
#
- name: gosc_file_test
  hosts: localhost
  gather_facts: false
  tasks:
    - block:
        - include_tasks: ../setup/test_setup.yml
        - name: Set fact of default Windows dir
          ansible.builtin.set_fact:
            win_dir: '$env:windir'
        - include_tasks: ../utils/win_get_path.yml
          vars:
            win_get_path_specified: "{{ win_dir }}"
        - name: Set fact of the absolute path of Windows dir
          ansible.builtin.set_fact:
            win_dir: "{{ win_get_path_absolute }}"
        - ansible.builtin.debug:
            msg: "Windows GOSC log files in Windows dir: {{ win_dir }}"
        - name: Set fact of the network customize type to dhcp
          ansible.builtin.set_fact:
            vm_dhcp_gosc_start: true

      rescue:
        - include_tasks: ../../common/test_rescue.yml
      always:
        - block:
            - include_tasks: ../../common/vm_get_power_state.yml
            # Get all gosc logs from guest to local
            - include_tasks: get_gosc_logs_network.yml
              when: vm_power_state_get == "poweredOn"
          when: vm_dhcp_gosc_start is defined and vm_dhcp_gosc_start
