# Copyright 2021-2026 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Fetch log files from Windows guest OS to local
- name: "Initialize the GOSC log files source and dest paths"
  ansible.builtin.set_fact:
    win_gosc_log_files: []
    win_gosc_log_files_dst: []
    win_gosc_log_src_dest: {}

- name: "Set fact of the relative file path list of GOSC log"
  ansible.builtin.set_fact:
    win_gosc_log_files_rel:
      - 'Temp\vmware-imc\guestcust.log'
      - 'Temp\vmware-imc\toolsDeployPkg.log'
      - 'System32\Sysprep\Panther\setupact.log'
      - 'System32\Sysprep\Panther\setuperr.log'
      - 'Panther\setupact.log'
      - 'Panther\setuperr.log'
      - 'Panther\unattend.xml'
      - 'Panther\UnattendGC\setupact.log'
      - 'Panther\UnattendGC\setuperr.log'
      - 'Debug\NetSetup.LOG'
      - 'Debug\PASSWD.LOG'
      - 'Debug\sammui.log'

- name: "Set fact of the absolute file path list of GOSC log"
  ansible.builtin.set_fact:
    win_gosc_log_files: >-
      {{ [win_windows_dir] | ansible.builtin.product(win_gosc_log_files_rel) |
      map('join', win_dir_separator) }}
    win_gosc_log_files_dst: >-
      {{ [current_test_log_folder] | ansible.builtin.product(win_gosc_log_files_rel) |
      map('join', win_dir_separator) | map('replace', win_dir_separator, '/') }}

- name: "Set fact of the source and dest log files path dict"
  ansible.builtin.set_fact:
    win_gosc_log_src_dest: "{{ dict(win_gosc_log_files | zip(win_gosc_log_files_dst)) }}"

- name: "Display the GOSC log files to be fetched"
  ansible.builtin.debug: var=win_gosc_log_src_dest

# Administrator password may be already changed when GOSC task failed
- name: "Check whether user 'Administrator' password is changed in guest OS"
  when:
    - vm_username | lower == "administrator"
    - vm_password != win_gosc_spec.gosc_logon_password
  block:
    - name: "Initialize the variables for testing user password"
      ansible.builtin.set_fact:
        gosc_log_pwd_need_change: false
        gosc_test_pwd_folder: "{{ 'C:\\gosc_test_pwd' ~ 10000 | random(start=1000) }}"
    - name: "Try to create test folder in guest OS"
      include_tasks: ../../common/vm_guest_file_operation.yml
      vars:
        operation: "create_dir"
        dir_path: "{{ gosc_test_pwd_folder }}"
        recurse: false
        guest_file_ops_ignore_error: true
    - name: "Set fact of whether current user password works"
      ansible.builtin.set_fact:
        gosc_log_pwd_need_change: true
      when:
        - create_dir_op.failed is defined
        - create_dir_op.failed
        - create_dir_op.msg is defined
        - create_dir_op.msg is search("Invalid guest login for user Administrator")
    - name: "Current user password works"
      ansible.builtin.debug:
        msg: "Creating test folder '{{ gosc_test_pwd_folder }}' in guest OS succeeded using user 'Administrator' current password."
      when:
        - create_dir_op.failed is defined
        - not create_dir_op.failed
    - name: "Change the user password for fetching log files"
      ansible.builtin.set_fact:
        vm_password: "{{ win_gosc_spec.gosc_logon_password }}"
      when: gosc_log_pwd_need_change

- name: "Fetch GOSC log files from guest OS"
  include_tasks: ../../common/vm_guest_file_operation.yml
  vars:
    operation: "fetch_file"
    src_path: "{{ item.key }}"
    dest_path: "{{ item.value }}"
    guest_file_ops_ignore_error: true
  loop: "{{ win_gosc_log_src_dest | dict2items }}"
