# Copyright 2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
- name: Set fact of uninstall OneDrive command 
  set_fact:
    uninstall_one_drive: "C:\\Windows\\SysWOW64\\OneDriveSetup.exe /uninstall"

- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "{{ uninstall_one_drive }}"

# Get installed OneDrive appx package name
- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "(Get-AppxPackage -AllUsers | Where PublisherId -eq 8wekyb3d8bbwe | Where PackageFullName -Like '*OneDriveSync*').PackageFullName"

- name: Set fact of OneDrive Sync appx package name
  set_fact:
    one_drive_appx_package_name: "{{ win_powershell_cmd_output.stdout_lines[0] }}"
  when:
    - win_powershell_cmd_output is defined
    - "'stdout_lines' in win_powershell_cmd_output"
    - win_powershell_cmd_output.stdout_lines | len != 0
 
- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "Remove-AppxPackage -Package {{ one_drive_appx_package_name }}"
  when:
    - one_drive_appx_package_name is defined
    - one_drive_appx_package_name
