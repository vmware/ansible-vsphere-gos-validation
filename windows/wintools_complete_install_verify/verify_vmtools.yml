# Copyright 2021-2026 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Refresh VM guest info
- name: "Update VM guest info after installing VMware Tools"
  include_tasks: ../../common/vm_get_guest_info.yml

# Get VMware Tools version
- name: "Get VMware Tools version and build number"
  include_tasks: ../utils/win_get_vmtools_version_build.yml

- name: "Set fact of expected VMware Tools services"
  ansible.builtin.set_fact:
    win_tools_services: |-
      {%- if esxi_cpu_vendor != 'arm' and (vmtools_version is defined and vmtools_version is version('10.3.0', '>=')) -%}
      ['VGAuthService', 'VMTools', 'vmvss']
      {%- else -%}
      ['VMTools']
      {% endif %}

- name: "Retry to get VMware Tools services list"
  include_tasks:
    file: ../utils/win_get_vmtools_service_list.yml
    apply:
      when: >
        (retry_time == 1) or
        (vmtools_service_dict | default({}) | length < win_tools_services | length) or
        ("'VGAuthService' in vmtools_service_dict" and vmtools_service_dict['VGAuthService'] != "Running") or
        ("'VMTools' in vmtools_service_dict" and vmtools_service_dict['VMTools'] != "Running")
  loop: "{{ range(1, 7) }}"
  loop_control:
    loop_var: retry_time
    pause: 5

- name: "Check service 'VGAuthService' is running"
  ansible.builtin.assert:
    that:
      - vmtools_service_dict.VGAuthService is defined
      - vmtools_service_dict['VGAuthService'] == "Running"
    fail_msg: >-
      Not get 'Running' status of service 'VGAuthService' in guest OS after 6 retries. Got services status dict: {{ vmtools_service_dict }}.
  when: "'VGAuthService' in win_tools_services"

- name: "Check service 'VMTools' is running"
  ansible.builtin.assert:
    that:
      - vmtools_service_dict.VMTools is defined
      - vmtools_service_dict['VMTools'] == "Running"
    fail_msg: >-
      Not get 'Running' status of service 'VMTools' in guest OS after 6 retries. Got services status dict: {{ vmtools_service_dict }}.

- name: "Get drivers with VMware or Broadcom manufacturer"
  include_tasks: ../utils/win_get_vmtools_driver_list.yml

- name: "Check drivers list not empty"
  ansible.builtin.assert:
    that:
      - vmtools_driver_list | length != 0
    fail_msg: "Not get installed drivers with VMware or Broadcom manufacturer after VMware Tools install."

- name: "Check usernames of VMware Tools processes in guest OS"
  include_tasks: ../utils/win_check_vmtoolsd_user.yml

# In Windows Server 2012 R2 or older OS there is no cmdlet 'Get-PnpDevice',
# so here only check in newer OS
- name: "Check if there is problem device in Device Manager"
  include_tasks: check_problem_device.yml
  when: guest_os_ansible_distribution_ver is version('6.3.9600.0', '>')
