# Copyright 2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
- name: Initialize the status of VM CPU Hardware virtualization
  ansible.builtin.set_fact:
    vm_nested_virt_status: false

# Get CPU Hardware virtualization status
- include_tasks: ../../common/vm_get_config.yml
  vars:
    property_list: ['config.nestedHVEnabled']

- name: Set fact of VM CPU Hardware virtualization status
  ansible.builtin.set_fact:
    vm_nested_virt_status: "{{ vm_config.config.nestedHVEnabled }}"
  when:
    - vm_config.config is defined
    - vm_config.config.nestedHVEnabled is defined

- name: Display VM CPU Hardware virtualization status
  ansible.builtin.debug:
    msg: "VM CPU Hardware virtualization status: {{ vm_nested_virt_status }}"

- name: Enable CPU Hardware virtualization
  block:
    - include_tasks: ../utils/win_shutdown_restart.yml
      vars:
        set_win_power_state: "shutdown"

    - include_tasks: ../../common/vm_set_nested_virtual.yml
      vars:
        vm_nested_virt: true

    - include_tasks: ../../common/vm_set_power_state.yml
      vars:
        vm_power_state_set: 'powered-on'
  when: not vm_nested_virt_status | bool

# Enable and start Microsoft Store Install Service
- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "Set-Service -Name InstallService -StartupType Automatic; Start-Service InstallService"