# Copyright 2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
# Install WSL distribution
# Parameters:
#     wsl_file_path: the path on Guest OS where the wsl command output messages are put
#     wsl_distribution_name: the WSL distribution name

# Installing distribution with parameter --no-launch will get the packages from Microsoft Store, but not actually
# install it
- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "wsl --install --no-launch -d {{ wsl_distribution_name }}| Out-File -FilePath {{ wsl_file_path }}\\wsl_get_distro.txt"
    win_execute_cmd_ignore_error: true

- include_tasks: wsl_convert_binary_to_txt.yml
  vars:
    source_path: "{{ wsl_file_path }}\\wsl_get_distro.txt"
    file_name: "wsl_get_distro.txt"

- name: Check WSL installation command result
  ansible.builtin.fail:
    msg: "Getting distribution {{ wsl_distribution_name }} failed. Please check log file wsl_get_distro.txt."
  when: win_powershell_cmd_output.rc != 0

# To resolve the popup window during WSL distribution installation, put the installation command into PS1 file and
# execute it on system startup
- name: Set the facts for wsl powershell script
  ansible.builtin.set_fact:
    wsl_ps1_path: "{{ wsl_file_path }}\\install_wsl_distro.ps1"
    wsl_ps1_log_path: "{{ wsl_file_path }}\\install_distro.txt"
    wsl_ps1_content: "wsl --install -d {{ wsl_distribution_name }}"

- name: Set the facts for startup script
  ansible.builtin.set_fact:
    startup_path: "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\wslscript.cmd"
    startup_content: "powershell.exe -ExecutionPolicy Unrestricted -File {{ wsl_ps1_path }} >> {{ wsl_ps1_log_path }}"

# Create the powershell script for installing WSL distribution
- include_tasks: ../utils/win_create_file.yml
  vars:
    new_empty_file_path: "{{ wsl_ps1_path }}"
- include_tasks: ../utils/win_write_to_file.yml
  vars:
    write_file_path: "{{ wsl_ps1_path }}"
    write_file_content: "{{ wsl_ps1_content }}"

# Create the cmd file which will run the above powershell script on system start up
- include_tasks: ../utils/win_create_file.yml
  vars:
    new_empty_file_path: "{{ startup_path }}"
- include_tasks: ../utils/win_write_to_file.yml
  vars:
    write_file_path: "{{ startup_path }}"
    write_file_content: "{{ startup_content }}"

# Restart the Guest OS to run the installation script
- include_tasks: ../utils/win_shutdown_restart.yml
  vars:
    set_win_power_state: "restart"

- include_tasks: wsl_convert_binary_to_txt.yml
  vars:
    source_path: "{{ wsl_ps1_log_path }}"
    file_name: "install_distro.txt"

# The installation of the distribution will take several minutes.
- name: List installed WSL distribution
  ansible.windows.win_shell: "wsl --list | Out-File -FilePath {{ wsl_file_path }}\\wsl_list_distro.txt"
  register: win_powershell_cmd_output
  ignore_errors: true
  delegate_to: "{{ vm_guest_ip }}"
  ignore_unreachable: true
  until: win_powershell_cmd_output.rc == 0
  retries: 5
  delay: 60

- include_tasks: wsl_convert_binary_to_txt.yml
  vars:
    source_path: "{{ wsl_file_path }}\\wsl_list_distro.txt"
    file_name: "wsl_list_distro.txt"
    
- name: Validate the distribution installation result
  ansible.builtin.assert:
    that:
      - "{{win_powershell_cmd_output.rc==0 }}"
    fail_msg: "The installation of WSL distribution {{ wsl_distribution_name }} failed."