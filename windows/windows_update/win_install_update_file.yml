# Copyright 2023 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Install Windows Update msu file
#
# Transfer PowerShell script to guest OS
- name: "Set fact of PowerShell script file path"
  ansible.builtin.set_fact:
    local_ps_file: "{{ current_test_log_folder }}/{{ win_install_msu_script }}"
    remote_ps_file: "C:\\{{ win_install_msu_script }}"
- name: "Copy the script from local to guest OS"
  include_tasks: ../utils/win_copy_file_from_local.yml
  vars:
    src_path_local: "{{ local_ps_file }}"
    dest_path_remote: "C:\\"
- name: "Check if file exists in guest OS"
  include_tasks: ../utils/win_check_file_exist.yml
  vars:
    win_check_file_exist_file: "{{ remote_ps_file }}"

- name: "Install Windows Update file"
  when:
    - win_check_file_exist_result is defined
    - win_check_file_exist_result | bool
  block:
    - name: "Execute PowerShell script in guest OS"
      ansible.windows.win_command: "powershell.exe -ExecutionPolicy bypass -File {{ remote_ps_file }} "
      delegate_to: "{{ vm_guest_ip }}"
      ignore_errors: true
      register: install_update_result
    - name: "Display the script execute result"
      ansible.builtin.debug: var=install_update_result
      when: enable_debug
