# Copyright 2021 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# This file is used to hotadd and hot remove disk controller and disk of VM.
# Disk controller types notes:
# - paravirtual: require pvscsi driver installed or VMware tools installed.
# - lsilogicsas: the default disk controller type of VM.
# - lsilogic: no inbox driver in Windows guest OS now, so no testing.
# - nvme: use the version of community.vmware collection which contains this controller type support.
# - sata: use the version of community.vmware collection which contains this controller type support.
# - buslogic: not supported in 64bit Windows guest OS, no testing.
#
- include_tasks: hotadd_remove_vhba_test_prepare.yml

# Get the number of controllers and disks in guest OS before hotadd
- include_tasks: get_guest_disk_ctl_num.yml
- name: Set fact of the controller number and disk number before hotadd
  set_fact:
    ctl_num_guest_before_hotadd: "{{ ctl_num_guest }}"
    disk_num_guest_before_hotadd: "{{ disk_num_guest }}"

# test on adding new disk on the existing controller
- block:
    # Test on adding new disk controller and new disk at same time
    - include_tasks: hotadd_vm_controller_disk.yml
      vars:
        in_new_disk_new_ctl: True
        new_disk_unit_num: 0
    - include_tasks: hotremove_vm_controller_disk.yml
      vars:
        in_new_disk_new_ctl: True
        new_disk_unit_num: 0
    - name: Set fact of test on new disk and new disk controller
      set_fact:
        new_disk_new_ctl: True

    # Test on adding a new disk on the existing controller
    - include_tasks: hotadd_vm_controller_disk.yml
      vars:
        in_new_disk_new_ctl: False
        new_disk_unit_num: 1
    - include_tasks: hotremove_vm_controller_disk.yml
      vars:
        in_new_disk_new_ctl: False
        new_disk_unit_num: 1
    - name: Set fact of test on new disk on existing disk controller
      set_fact:
        new_disk_existing_ctl: True
  when:
    - add_new_controller
    - new_vhba_bus_found is defined and new_vhba_bus_found

- name: "Skip testcase: {{ ansible_play_name }}"
  debug:
    msg: "Skip test case due to controller '{{ disk_controller }}' number is already 4: {{ vhba_number_before_hotadd }}, or not get new disk controller bus number."
  when: >
    (not add_new_controller) or
    (new_vhba_bus_found is undefined) or
    (not new_vhba_bus_found)
