# Copyright 2021 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Get NVMe controller devices instance ID in guest OS after hotadd
- include_tasks: ../utils/win_get_nvme_ctl_inst_id_list.yml
- name: Set fact of the NVMe controller instance id list after hotadd
  set_fact:
    nvme_ctl_inst_id_list_after: "{{ nvme_ctl_instance_id_list }}"

- name: Set fact of the new added NVMe controller instance id
  set_fact:
    nvme_ctl_inst_id: "{{ nvme_ctl_inst_id_list_after | difference(nvme_ctl_inst_id_list_before) }}"

# Disable NVMe controller in guest OS
- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "pnputil /disable-device '{{ nvme_ctl_inst_id[0] }}'"

# Re-enable NVMe controller in guest OS
- include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: "pnputil /enable-device '{{ nvme_ctl_inst_id[0] }}'"
