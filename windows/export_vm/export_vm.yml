# Copyright 2021 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   This playbook is used for exporting VM to OVF
# template, by default the exported template files
# will be saved in '/tmp/' folder.
#
- name: export_ovf
  hosts: localhost
  gather_facts: no
  vars_files:
    - "{{ testing_vars_file | default('../../vars/test.yml') }}"
  tasks:
    # Check VM power status
    - include_tasks: ../../common/vm_get_power_state.yml
    # Power off VM if it's not in poweredOff state
    - include_tasks: ../utils/shutdown_vm.yml

    - include_tasks: ../../common/vm_get_cdrom_devices.yml
    - include_tasks: ../../common/vm_configure_cdrom.yml
      vars:
        cdrom_state: absent
        cdrom_controller_type: "{{ item.controllerKey }}"
        cdrom_controller_num: "{{ item.controllerKey }}"
        cdrom_unit_num: "{{ item.unitNumber }}"
      with_items: "{{ cdrom_device_list }}"
      when:
        - cdrom_device_list is defined
        - cdrom_device_list | length > 1

    # Change to 'client device' for CDROM devices which have ISO images connected

    # Export VM to ovf template to the specified path
    # Please make sure enough disk space in specified path
    - include_tasks: ../../common/ovf_export.yml
      vars:
        ovf_export_dst_path: "{{ exported_template_path | default('/tmp/') }}"
