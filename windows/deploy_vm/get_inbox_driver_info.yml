# Copyright 2022 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# From Windows Server 2022, there are inboxed PVSCSI and VMXNET3
# drivers. Here to get inbox drivers info.
#
- name: Initialize inbox drivers info dict
  set_fact:
    inbox_drivers_info: {}

- block:
    - include_tasks: win_get_device_driver.yml
      vars:
        device_desc_keyword: "pvscsi"
    - name: Add PVSCSI driver info
      set_fact:
        inbox_drivers_info: "{{ inbox_drivers_info | combine({'pvscsi': win_guest_device_driver}) }}"
  when:
    - boot_disk_controller is defined
    - boot_disk_controller == "paravirtual" 

- block:
    - include_tasks: win_get_device_driver.yml
      vars:
        device_desc_keyword: "vmxnet3"
    - name: Add VMXNET3 driver info
      set_fact:
        inbox_drivers_info: "{{ inbox_drivers_info | combine({'vmxnet3': win_guest_device_driver}) }}"
  when:
    - network_adapter_type is defined
    - network_adapter_type == "vmxnet3"

- name: Print inbox drivers info
  debug: var=inbox_drivers_info

- block:
    - name: Set fact of the file path for recording inbox drivers info
      set_fact:
        drivers_info_file_path: "{{ testrun_log_path }}/inbox_drivers_info.json"
    - name: Print the path of json file for recording inbox drivers info
      debug: var=drivers_info_file_path
    - name: Dump inbox drivers info to json file
      copy:
        dest: "{{ drivers_info_file_path }}"
        content: "{{ [inbox_drivers_info] | to_nice_json }}"
  when: inbox_drivers_info | length != 0
