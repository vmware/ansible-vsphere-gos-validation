
debug=yes
nonInteractive=yes

# Variations in the root disk device name between VMware and Virtualbox
if [ -e /dev/ada0 ]; then
    DISKSLICE=ada0
elif [ -e /dev/da0 ]; then
    DISKSLICE=da0
elif [ -e /dev/vtbd0 ]; then
    DISKSLICE=vtbd0
else
    echo "Unknown disk for install.sh to work with!"
    exit -1
fi

PARTITIONS="${DISKSLICE} gpt"
DISTRIBUTIONS="kernel.txz base.txz kernel-dbg.txz lib32.txz src.txz ports.txz"
# DISTRIBUTIONS="kernel.txz base.txz"


#!/bin/sh
set -o xtrace

echo 'Running installerconfig ...' > /dev/ttyu0
# Enable serial and internal consoles
echo "Enabling serial and internal consoles" 
echo "-Dhv" > /boot.config
echo "cuau0   \"/usr/libexec/getty std.9600\"  xterm   on  secure" >> /etc/ttys

#hostname
sysrc hostname="FreeBSD"

gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 da0
# Set Time Zone to UTC
echo "Setting Time Zone to UTC ..."
/bin/cp /usr/share/zoneinfo/UTC /etc/localtime
/usr/bin/touch /etc/wall_cmos_clock
/sbin/adjkerntz -a

echo "Set DHCP to NIC ${ifdev} ..." > /dev/ttyu0
ifdev=$(ifconfig | grep '^[a-z]' | cut -d: -f1 | head -n 1)
echo "Get ifname ${ifdev}"
sysrc ifconfig_${ifdev}=DHCP
sleep 5

# Add new user. 
{% if new_user is defined and new_user != 'root' %}
echo "{{ vm_password }}" | pw -V /etc useradd {{ new_user }} -h 0 -s /bin/sh -G wheel -d /home/{{ new_user }} -c "{{ new_user }} User"
mkdir -p /home/{{ new_user }}
chown 1001:1001 /home/{{ new_user }}
{% endif %}

# Set password of root user
echo "{{ vm_password }}" | pw -V /etc usermod root -h 0

# Set latest repository to the new system
echo "Set latest repository to the new system ..." > /dev/ttyu0
env ASSUME_ALWAYS_YES=YES pkg bootstrap -f | cat
bit=`uname -m`
OSFamily=`uname -s`
major_version=`freebsd-version -k | cut -d . -f 1`
repo="${OSFamily}:${major_version}:${bit}"

mkdir -p /usr/local/etc/pkg/repos
cat << EOF > /usr/local/etc/pkg/repos/latest.conf
FreeBSD: { enabled: no }

latest: {                                                                     
  url: "pkg+http://pkg.FreeBSD.org/${repo}/latest",
  mirror_type: "srv",                                                           
  signature_type: "fingerprints",                                               
  fingerprints: "/usr/share/keys/pkg",                                         
  enabled: yes                                                                 
}
EOF

# Get DHCP for nic0
echo "Get IP with dhclient ..." > /dev/ttyu0
dhclient ${ifdev}
sleep 15
echo "Check network ..." > /dev/ttyu0
ifconfig > /dev/ttyu0

# Installing packages
echo "Installing packages ..." > /dev/ttyu0
env ASSUME_ALWAYS_YES=YES pkg bootstrap -y
env ASSUME_ALWAYS_YES=YES pkg update -f
# The open-vm-tools is not installed by default
env ASSUME_ALWAYS_YES=YES pkg install -y python3
env ASSUME_ALWAYS_YES=YES pkg install -y open-vm-tools-nox11 | cat
# env ASSUME_ALWAYS_YES=YES pkg install -y sudo lsblk bash curl wget sudo
sleep 10

# Enable root login via ssh
echo "Enable root login via ssh ..." > /dev/ttyu0
mkdir -p -m 700 /root/.ssh
echo "{{ ssh_public_key }}" > /root/.ssh/authorized_keys
chown -R root /root/.ssh
chmod 0644 /root/.ssh/authorized_keys
# We can't ssh to VM with empty password for root user
sed -i .bak -e 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i '' -e 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i '' -e 's/#PermitEmpty.*/PermitEmptyPasswords yes/' /etc/ssh/sshd_config

# Enable service
echo "Enable service ..." > /dev/ttyu0
sysrc sshd_enable="YES"
sysrc ntpd_enable="YES"
sysrc ntpd_sync_on_start="YES"

# Removing boot menu delay
echo "Removing boot menu delay ..." > /dev/ttyu0
echo 'autoboot_delay="3"' >> /boot/loader.conf

echo "End of installerconfig" > /dev/ttyu0
echo "{{ autoinstall_complete_msg }}" > /dev/ttyu0
# shutdown -p now
shutdown -r now




