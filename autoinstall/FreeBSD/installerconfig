
debug=yes
nonInteractive=yes

PARTITIONS="da0 gpt"
DISTRIBUTIONS="kernel.txz base.txz kernel-dbg.txz lib32.txz src.txz ports.txz"

#!/bin/sh
# Set hostname
sysrc hostname="FreeBSD"

gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 da0
# Set Time Zone to UTC
echo "Setting Time Zone to UTC ..."
/bin/cp /usr/share/zoneinfo/UTC /etc/localtime
/usr/bin/touch /etc/wall_cmos_clock
/sbin/adjkerntz -a

echo "Set DHCP to NIC nic0 ..." > /dev/ttyu0
ifdev=$(ifconfig | grep '^[a-z]' | cut -d: -f1 | head -n 1)
echo "Get ifname ${ifdev}"
sysrc ifconfig_${ifdev}=DHCP

# Get DHCP for nic0
echo "Get IP with dhclient ..." > /dev/ttyu0
dhclient ${ifdev}
sleep 15
echo "Check network ..." > /dev/ttyu0
ifconfig > /dev/ttyu0

# Set Proxy. without the proxy, it will take about one day to download pakages xorg & gnome
# The setting will be remove 
setenv HTTP_PROXY http://proxy.vmware.com:3128
setenv HTTPS_PROXY https://proxy.vmware.com:3128

# Installing packages
echo "Installing packages ..." > /dev/ttyu0
env ASSUME_ALWAYS_YES=YES pkg bootstrap -y
env ASSUME_ALWAYS_YES=YES pkg update -f
env ASSUME_ALWAYS_YES=YES pkg upgrade -f
# Hit issue: reset by peer during install packages
# The open-vm-tools is not installed by default
# packages_to_install='python3 open-vm-tools-nox11 sudo xorg lsblk bash curl wget xf86-video-vmware xf86-input-vmmouse ...'
packages_to_install='python3 sudo xorg gnome open-vm-tools xf86-video-vmware xf86-input-vmmouse bash wget'
for package_to_install in $packages_to_install
do
    try_count=0
    ret=1
    until [ $ret -eq 0 ] || [ $try_count -gt 10 ]
    do
        try_count=$((try_count+1))
        echo "Install package $package_to_install (try $try_count time) ..." > /dev/ttyu0
        env ASSUME_ALWAYS_YES=YES pkg install -y $package_to_install
        ret=$?
    done
    echo "The package($package_to_install) is already installed" > /dev/ttyu0
done

# Add new user. 
{% if new_user is defined and new_user != 'root' %}
echo "{{ vm_password }}" | pw -V /etc useradd {{ new_user }} -h 0 -s /bin/sh -G wheel -d /home/{{ new_user }} -c "{{ new_user }} User"
mkdir -p /home/{{ new_user }}
chown 1001:1001 /home/{{ new_user }}
echo '{{ new_user }} ALL=(ALL:ALL) ALL' >> /usr/local/etc/sudoers
{% endif %}

# Set password of root user
echo "{{ vm_password }}" | pw -V /etc usermod root -h 0

# Enable root login via ssh
echo "Enable root login via ssh ..." > /dev/ttyu0
mkdir -p -m 700 /root/.ssh
echo "{{ ssh_public_key }}" > /root/.ssh/authorized_keys
chown -R root /root/.ssh
chmod 0644 /root/.ssh/authorized_keys
# We can't ssh to VM with empty password for root user
sed -i .bak -e 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i '' -e 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

# Enable service
echo "Enable service ..." > /dev/ttyu0
sysrc sshd_enable="YES"
sysrc ntpd_enable="YES"
sysrc ntpd_sync_on_start="YES"

# Config desktop after install xorg and gnome
sysrc hald_enable="YES"
sysrc dbus_enable="YES"
sysrc gnome_enable="YES"
sysrc moused_enable="YES"
sysrc gdm_enable="YES"
Xorg -configure
cp xorg.conf.new /etc/X11/xorg.conf

# Removing boot menu delay
echo "Removing boot menu delay ..." > /dev/ttyu0
echo 'autoboot_delay="3"' >> /boot/loader.conf

echo "End of installerconfig" > /dev/ttyu0
echo "{{ autoinstall_complete_msg }}" > /dev/ttyu0
shutdown -r now

